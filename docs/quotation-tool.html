<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>견적 시뮬레이터 - 워크위드 내부용</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #f5f7fa; color: #333;
            font-size: 14px; line-height: 1.6;
            letter-spacing: -0.02em;
        }

        /* 상단 헤더 */
        .app-header {
            background: #1a365d; color: #fff;
            padding: 16px 30px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        .app-header h1 { font-size: 18px; font-weight: 600; letter-spacing: 1px; }
        .app-header .sub { font-size: 11px; color: rgba(255,255,255,0.5); margin-left: 12px; }
        .header-actions { display: flex; gap: 10px; }
        .header-actions button {
            background: rgba(255,255,255,0.15); color: #fff; border: 1px solid rgba(255,255,255,0.2);
            padding: 6px 14px; border-radius: 6px; font-size: 12px; cursor: pointer;
            font-family: inherit; transition: all 0.2s;
        }
        .header-actions button:hover { background: rgba(255,255,255,0.25); }

        /* 탭 네비게이션 */
        .tab-nav {
            background: #fff; border-bottom: 1px solid #e2e8f0;
            padding: 0 30px; display: flex; gap: 0;
            position: sticky; top: 54px; z-index: 99;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .tab-btn {
            padding: 14px 20px; border: none; background: none;
            font-family: inherit; font-size: 13px; color: #718096;
            cursor: pointer; border-bottom: 3px solid transparent;
            transition: all 0.2s; white-space: nowrap;
        }
        .tab-btn:hover { color: #1a365d; background: #f7fafc; }
        .tab-btn.active {
            color: #1a365d; font-weight: 600;
            border-bottom-color: #1a365d;
        }
        .tab-btn .tab-num {
            display: inline-block; background: #e2e8f0; color: #718096;
            width: 20px; height: 20px; border-radius: 50%; text-align: center;
            line-height: 20px; font-size: 10px; margin-right: 6px;
            font-weight: 600;
        }
        .tab-btn.active .tab-num { background: #1a365d; color: #fff; }
        .tab-btn.done .tab-num { background: #38a169; color: #fff; }

        /* 메인 콘텐츠 */
        .main { max-width: 900px; margin: 0 auto; padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* 카드 */
        .card {
            background: #fff; border-radius: 10px;
            padding: 28px; margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e8ecf1;
        }
        .card-title {
            font-size: 16px; font-weight: 600; color: #1a365d;
            margin-bottom: 20px; padding-bottom: 12px;
            border-bottom: 1px solid #edf2f7;
        }

        /* 폼 요소 */
        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block; font-size: 12px; font-weight: 600;
            color: #4a5568; margin-bottom: 6px;
        }
        .form-label .hint { font-weight: 400; color: #a0aec0; margin-left: 6px; }
        input[type="text"], input[type="number"], select, textarea {
            width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0;
            border-radius: 8px; font-family: inherit; font-size: 14px;
            color: #333; background: #fff; transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: #1a365d;
            box-shadow: 0 0 0 3px rgba(26,54,93,0.1);
        }
        textarea { resize: vertical; min-height: 60px; }

        .form-row { display: flex; gap: 16px; }
        .form-row .form-group { flex: 1; }

        /* 라디오/체크박스 그룹 */
        .option-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .option-btn {
            padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 8px;
            background: #fff; cursor: pointer; font-size: 13px;
            transition: all 0.2s; font-family: inherit;
        }
        .option-btn:hover { border-color: #1a365d; }
        .option-btn.selected {
            background: #1a365d; color: #fff; border-color: #1a365d;
        }

        /* 결과 박스 */
        .result-box {
            background: #f0f5ff; border: 1px solid #bee3f8;
            border-radius: 10px; padding: 20px; margin-top: 16px;
        }
        .result-box.warning {
            background: #fffaf0; border-color: #fbd38d;
        }
        .result-box.success {
            background: #f0fff4; border-color: #9ae6b4;
        }
        .result-title {
            font-size: 13px; font-weight: 600; color: #2b6cb0;
            margin-bottom: 10px;
        }
        .result-box.warning .result-title { color: #c05621; }
        .result-box.success .result-title { color: #276749; }
        .result-value {
            font-size: 28px; font-weight: 700; color: #1a365d;
        }
        .result-sub { font-size: 12px; color: #718096; margin-top: 4px; }

        /* 테이블 */
        .data-table { width: 100%; border-collapse: collapse; margin: 12px 0; }
        .data-table th {
            background: #f7fafc; padding: 10px 14px; text-align: left;
            font-size: 12px; font-weight: 600; color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }
        .data-table td {
            padding: 10px 14px; border-bottom: 1px solid #edf2f7;
            font-size: 13px;
        }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table .num { text-align: right; font-variant-numeric: tabular-nums; }
        .data-table .highlight { color: #1a365d; font-weight: 600; }
        .data-table .danger { color: #e53e3e; }
        .data-table .safe { color: #38a169; }
        .data-table tfoot td {
            font-weight: 600; border-top: 2px solid #1a365d;
            background: #f7fafc;
        }

        /* 시뮬레이션 시나리오 카드 */
        .scenario-cards { display: flex; gap: 16px; margin-top: 16px; }
        .scenario-card {
            flex: 1; border-radius: 10px; padding: 20px;
            border: 2px solid #e2e8f0; text-align: center;
            transition: all 0.2s;
        }
        .scenario-card.primary { border-color: #1a365d; background: #f0f5ff; }
        .scenario-card.secondary { border-color: #ed8936; background: #fffaf0; }
        .scenario-card.danger { border-color: #e53e3e; background: #fff5f5; }
        .scenario-label { font-size: 11px; font-weight: 600; color: #718096; margin-bottom: 8px; letter-spacing: 1px; }
        .scenario-card.primary .scenario-label { color: #1a365d; }
        .scenario-card.secondary .scenario-label { color: #c05621; }
        .scenario-card.danger .scenario-label { color: #e53e3e; }
        .scenario-amount { font-size: 24px; font-weight: 700; color: #333; margin-bottom: 4px; }
        .scenario-detail { font-size: 12px; color: #718096; }
        .scenario-input {
            width: 80px; text-align: center; border: 1px solid #e2e8f0;
            border-radius: 6px; padding: 4px; font-size: 14px; font-weight: 600;
            margin: 0 4px; font-family: inherit;
        }

        /* 체크리스트 */
        .checklist { list-style: none; }
        .checklist li {
            padding: 14px 16px; border-bottom: 1px solid #edf2f7;
            display: flex; align-items: center; gap: 12px;
            cursor: pointer; transition: background 0.15s; border-radius: 6px;
        }
        .checklist li:hover { background: #f7fafc; }
        .checklist li.checked { opacity: 0.6; }
        .checklist li.checked .check-text { text-decoration: line-through; }
        .check-box {
            width: 22px; height: 22px; border: 2px solid #cbd5e0;
            border-radius: 6px; display: flex; align-items: center;
            justify-content: center; flex-shrink: 0; transition: all 0.2s;
        }
        .checklist li.checked .check-box {
            background: #38a169; border-color: #38a169; color: #fff;
        }
        .check-text { font-size: 14px; }
        .check-step {
            font-size: 11px; font-weight: 600; color: #1a365d;
            background: #edf2f7; padding: 2px 8px; border-radius: 4px;
            margin-right: 4px;
        }

        /* 버튼 */
        .btn {
            padding: 12px 24px; border-radius: 8px; border: none;
            font-family: inherit; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; display: inline-flex;
            align-items: center; gap: 8px;
        }
        .btn-primary { background: #1a365d; color: #fff; }
        .btn-primary:hover { background: #2d4a7a; }
        .btn-secondary { background: #edf2f7; color: #4a5568; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-success { background: #38a169; color: #fff; }
        .btn-success:hover { background: #2f855a; }
        .btn-danger { background: #e53e3e; color: #fff; }
        .btn-danger:hover { background: #c53030; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }

        /* 진행 표시 */
        .progress-bar {
            height: 4px; background: #e2e8f0; border-radius: 2px;
            margin: 8px 0; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: #38a169; border-radius: 2px;
            transition: width 0.3s;
        }

        /* 알림 */
        .alert {
            padding: 12px 16px; border-radius: 8px; font-size: 13px;
            margin-bottom: 16px; display: flex; align-items: flex-start; gap: 8px;
        }
        .alert-info { background: #ebf8ff; color: #2b6cb0; border: 1px solid #bee3f8; }
        .alert-warning { background: #fffaf0; color: #c05621; border: 1px solid #fbd38d; }
        .alert-danger { background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; }

        /* 견적서 미리보기 */
        .preview-frame {
            background: #fff; border: 1px solid #e2e8f0;
            border-radius: 4px; padding: 0;
            max-height: 600px; overflow-y: auto;
        }
        .preview-frame iframe {
            width: 100%; height: 800px; border: none;
        }

        /* 저장 상태 표시 */
        .save-indicator {
            font-size: 11px; color: rgba(255,255,255,0.6);
            display: flex; align-items: center; gap: 4px;
        }
        .save-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: #38a169;
        }

        /* 이력 모달 */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #fff; border-radius: 12px; width: 90%; max-width: 700px;
            max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding: 20px 24px; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h2 { font-size: 18px; font-weight: 600; color: #1a365d; }
        .modal-close { background: none; border: none; font-size: 22px; cursor: pointer; color: #718096; padding: 4px 8px; }
        .modal-body { padding: 20px 24px; overflow-y: auto; max-height: calc(80vh - 130px); }
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 16px; border: 1px solid #e2e8f0; border-radius: 8px;
            margin-bottom: 8px; cursor: pointer; transition: all 0.15s;
        }
        .history-item:hover { background: #f7fafc; border-color: #1a365d; }
        .history-info { flex: 1; }
        .history-client { font-weight: 600; color: #1a365d; font-size: 14px; }
        .history-meta { font-size: 12px; color: #718096; margin-top: 2px; }
        .history-amount { font-weight: 700; color: #1a365d; font-size: 15px; text-align: right; min-width: 120px; }
        .history-actions { display: flex; gap: 6px; margin-left: 12px; }
        .history-actions button {
            padding: 4px 10px; border-radius: 4px; border: 1px solid #e2e8f0;
            background: #fff; font-size: 11px; cursor: pointer; font-family: inherit;
        }
        .history-actions .btn-load { color: #1a365d; border-color: #1a365d; }
        .history-actions .btn-load:hover { background: #1a365d; color: #fff; }
        .history-actions .btn-del { color: #e53e3e; border-color: #e53e3e; }
        .history-actions .btn-del:hover { background: #e53e3e; color: #fff; }
        .history-empty { text-align: center; color: #a0aec0; padding: 40px; font-size: 14px; }
        .history-badge {
            display: inline-block; padding: 2px 8px; border-radius: 10px;
            font-size: 10px; font-weight: 600; margin-left: 6px;
        }
        .badge-win { background: #c6f6d5; color: #276749; }
        .badge-loss { background: #fed7d7; color: #9b2c2c; }
        .badge-pending { background: #fefcbf; color: #975a16; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #e2e8f0; text-align: right; }

        /* 요율 설정 토글 */
        .rate-toggle {
            font-size: 12px; color: #2b6cb0; cursor: pointer; margin-left: 8px;
            border: none; background: none; font-family: inherit; text-decoration: underline;
        }
        .rate-settings { display: none; margin-top: 12px; }
        .rate-settings.open { display: block; }
        .rate-row {
            display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
        }
        .rate-item {
            display: flex; align-items: center; gap: 4px; font-size: 12px; color: #4a5568;
        }
        .rate-item input {
            width: 65px; text-align: center; padding: 4px 6px; font-size: 12px;
            border: 1px solid #e2e8f0; border-radius: 4px;
        }

        /* 견적 유형 선택 */
        .type-selector {
            display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;
        }
        .type-card {
            flex: 1; min-width: 140px; padding: 16px; border: 2px solid #e2e8f0;
            border-radius: 10px; cursor: pointer; text-align: center;
            transition: all 0.2s; background: #fff;
        }
        .type-card:hover { border-color: #1a365d; background: #f7fafc; }
        .type-card.selected { border-color: #1a365d; background: #f0f5ff; }
        .type-card .type-icon { font-size: 24px; margin-bottom: 6px; }
        .type-card .type-name { font-size: 13px; font-weight: 600; color: #1a365d; }
        .type-card .type-desc { font-size: 11px; color: #718096; margin-top: 4px; }

        /* 유형별 표시/숨김 */
        .for-outsource, .for-labor, .for-cs-agent, .for-cs-share, .for-recruit { display: none; }
        body.qt-outsource .for-outsource { display: block; }
        body.qt-labor .for-labor { display: block; }
        body.qt-cs-agent .for-cs-agent { display: block; }
        body.qt-cs-share .for-cs-share { display: block; }
        body.qt-recruit .for-recruit { display: block; }
        /* flex 복원 */
        body.qt-outsource .for-outsource.d-flex { display: flex; }
        body.qt-labor .for-labor.d-flex { display: flex; }
        body.qt-cs-agent .for-cs-agent.d-flex { display: flex; }
        body.qt-cs-share .for-cs-share.d-flex { display: flex; }
        body.qt-recruit .for-recruit.d-flex { display: flex; }
        /* 공통 표시 (정액/일반 도급 공유) */
        .for-dogup { display: none; }
        body.qt-outsource .for-dogup, body.qt-labor .for-dogup { display: block; }
        body.qt-outsource .for-dogup.d-flex, body.qt-labor .for-dogup.d-flex { display: flex; }
        /* CS 공통 (CS대행+쉐어링) */
        .for-cs { display: none; }
        body.qt-cs-agent .for-cs, body.qt-cs-share .for-cs { display: block; }

        /* 인쇄 숨김 */
        @media print { body > *:not(.print-target) { display: none !important; } }

        /* 반응형 */
        @media (max-width: 768px) {
            .form-row { flex-direction: column; gap: 0; }
            .scenario-cards { flex-direction: column; }
            .tab-nav { overflow-x: auto; }
            .main { padding: 16px; }
        }
    </style>
</head>
<body>

<!-- ===== 상단 헤더 ===== -->
<div class="app-header">
    <div style="display:flex; align-items:center;">
        <h1>견적 시뮬레이터</h1>
        <span class="sub">워크위드 내부용 v3.0</span>
    </div>
    <div style="display:flex;align-items:center;gap:16px;">
        <div class="save-indicator">
            <span class="save-dot"></span>
            <span id="saveStatus">자동 저장됨</span>
        </div>
        <div class="header-actions">
            <button onclick="saveToHistory()" style="background:rgba(56,161,105,0.3);border-color:rgba(56,161,105,0.5);">저장</button>
            <button onclick="showHistory()">이력조회</button>
            <button onclick="resetAll()">새 견적</button>
        </div>
    </div>
</div>

<!-- ===== 탭 네비게이션 ===== -->
<div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab(0)"><span class="tab-num">1</span>고객정보</button>
    <button class="tab-btn" onclick="switchTab(1)"><span class="tab-num">2</span>인원산출</button>
    <button class="tab-btn" onclick="switchTab(2)"><span class="tab-num">3</span>원가계산</button>
    <button class="tab-btn" onclick="switchTab(3)"><span class="tab-num">4</span>견적시뮬</button>
    <button class="tab-btn" onclick="switchTab(4)"><span class="tab-num">5</span>견적서생성</button>
    <button class="tab-btn" onclick="switchTab(5)"><span class="tab-num">6</span>체크리스트</button>
</div>

<!-- ===== 메인 ===== -->
<div class="main">

    <!-- ==================== 탭1: 고객정보 ==================== -->
    <div class="tab-content active" id="tab0">
        <div class="card">
            <div class="card-title">견적 유형 선택</div>
            <div class="type-selector">
                <div class="type-card selected" onclick="switchQuoteType('outsource', this)">
                    <div class="type-icon">🏢</div>
                    <div class="type-name">정액제 도급</div>
                    <div class="type-desc">월 총액 정액<br>(오토스테이 등)</div>
                </div>
                <div class="type-card" onclick="switchQuoteType('labor', this)">
                    <div class="type-icon">🏭</div>
                    <div class="type-name">일반 도급</div>
                    <div class="type-desc">1인 단가 × 인원<br>(제조/물류 등)</div>
                </div>
                <div class="type-card" onclick="switchQuoteType('cs-agent', this)">
                    <div class="type-icon">📞</div>
                    <div class="type-name">CS대행</div>
                    <div class="type-desc">전담 상담사 배치<br>(위드콜)</div>
                </div>
                <div class="type-card" onclick="switchQuoteType('cs-share', this)">
                    <div class="type-icon">📊</div>
                    <div class="type-name">CS쉐어링</div>
                    <div class="type-desc">콜 구간별 과금<br>(공유 상담)</div>
                </div>
                <div class="type-card" onclick="switchQuoteType('recruit', this)">
                    <div class="type-icon">🤝</div>
                    <div class="type-name">채용대행</div>
                    <div class="type-desc">인력 소개 수수료<br>(직무별 단가)</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">고객 / 사업장 정보</div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">업체명</label>
                    <input type="text" id="clientName" placeholder="예: 오토스테이" oninput="autoSave()">
                </div>
                <div class="form-group">
                    <label class="form-label">사업장명</label>
                    <input type="text" id="siteName" placeholder="예: 성수점" oninput="autoSave()">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">업종</label>
                    <select id="industry" onchange="onIndustryChange(); autoSave();">
                        <option value="">선택</option>
                        <option value="세차/주차">세차/주차</option>
                        <option value="물류/택배">물류/택배</option>
                        <option value="제조라인">제조 라인</option>
                        <option value="사무/행정">사무/행정</option>
                        <option value="CS/콜센터">CS/콜센터</option>
                        <option value="이커머스">이커머스</option>
                        <option value="경비/시설">경비/시설관리</option>
                        <option value="호텔/숙박">호텔/숙박</option>
                        <option value="식품제조">식품 제조</option>
                        <option value="기타">기타</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">담당자</label>
                    <input type="text" id="contactName" placeholder="이름" oninput="autoSave()">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">연락처</label>
                    <input type="text" id="contactPhone" placeholder="010-0000-0000" oninput="autoSave()">
                </div>
                <div class="form-group">
                    <label class="form-label">이메일</label>
                    <input type="text" id="contactEmail" placeholder="email@example.com" oninput="autoSave()">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">유입 경로</label>
                <div class="option-group">
                    <button class="option-btn" onclick="selectOption(this,'source')">크몽</button>
                    <button class="option-btn" onclick="selectOption(this,'source')">소개</button>
                    <button class="option-btn" onclick="selectOption(this,'source')">직접문의</button>
                    <button class="option-btn" onclick="selectOption(this,'source')">기타</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">현재 운영 방식</label>
                <div class="option-group">
                    <button class="option-btn" onclick="selectOption(this,'currentOps')">직접고용</button>
                    <button class="option-btn" onclick="selectOption(this,'currentOps')">타사 아웃소싱</button>
                    <button class="option-btn" onclick="selectOption(this,'currentOps')">신규 사업장</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">아웃소싱 검토 이유 <span class="hint">(추정)</span></label>
                <textarea id="reason" placeholder="관리 부담, 인력 수급 어려움, 신규 매장 등" oninput="autoSave()"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">특이사항 / 메모</label>
                <textarea id="memo" placeholder="채용공고 시급, 경쟁사 정보, 기타 참고사항" oninput="autoSave()"></textarea>
            </div>
        </div>

        <div id="industryTip" class="alert alert-info" style="display:none;"></div>

        <div class="btn-group" style="justify-content:flex-end;">
            <button class="btn btn-primary" onclick="switchTab(1)">다음: 인원산출 &rarr;</button>
        </div>
    </div>

    <!-- ==================== 탭2: 인원산출 ==================== -->
    <div class="tab-content" id="tab1">

        <!-- ===== CS대행 전용: 상담사 구성 ===== -->
        <div class="for-cs-agent">
            <div class="card">
                <div class="card-title">상담사 구성 (위드콜)</div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">선임 상담사 수</label>
                        <input type="number" id="csSeniorCount" value="1" min="0" max="20" onchange="calcCSAgent(); autoSave();">
                    </div>
                    <div class="form-group">
                        <label class="form-label">선임 월급 (원)</label>
                        <input type="number" id="csSeniorSalary" value="3200000" step="100000" onchange="calcCSAgent(); autoSave();">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">일반 상담사 수</label>
                        <input type="number" id="csJuniorCount" value="1" min="0" max="20" onchange="calcCSAgent(); autoSave();">
                    </div>
                    <div class="form-group">
                        <label class="form-label">일반 월급 (원)</label>
                        <input type="number" id="csJuniorSalary" value="2900000" step="100000" onchange="calcCSAgent(); autoSave();">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ASP 패키지 (인당/월)</label>
                        <input type="number" id="csASP" value="350000" step="10000" onchange="calcCSAgent(); autoSave();">
                    </div>
                    <div class="form-group">
                        <label class="form-label">관리수수료 (%)</label>
                        <input type="number" id="csMgmtFee" value="8" step="1" min="0" max="30" onchange="calcCSAgent(); autoSave();">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">초기 구축비 (원) <span class="hint">1회성, 0이면 면제</span></label>
                        <input type="number" id="csSetupFee" value="1000000" step="100000" onchange="autoSave();">
                    </div>
                    <div class="form-group">
                        <label class="form-label">운영시간</label>
                        <input type="text" id="csOpTime" value="09:00~18:00 (휴게 1시간 제외)" oninput="autoSave();">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">인력 근무조건</label>
                    <input type="text" id="csWorkCond" value="평일 주간 일 8T" oninput="autoSave();">
                </div>

                <div class="form-group">
                    <label class="form-label">업무범위</label>
                    <textarea id="csWorkScope" rows="3" placeholder="예: CS관련 업무(인바운드) + 영업 문의 초기 대응" oninput="autoSave();">CS관련 업무(인바운드) + 영업 문의 초기 대응</textarea>
                </div>
            </div>

            <div class="card">
                <div class="card-title">CS대행 비용 산출</div>
                <table class="data-table">
                    <thead><tr><th>항목</th><th style="text-align:right;">단가</th><th style="text-align:right;">인원</th><th style="text-align:right;">합계</th></tr></thead>
                    <tbody id="csAgentCostDetail"></tbody>
                    <tfoot>
                        <tr><td><strong>총계 (VAT별도)</strong></td><td></td><td></td><td class="num" id="csAgentTotal" style="font-size:16px;">-</td></tr>
                    </tfoot>
                </table>

                <div class="result-box" style="margin-top:16px;">
                    <div class="result-title">최종 제안가</div>
                    <div style="display:flex;gap:16px;align-items:center;">
                        <input type="number" id="csAgentFinalPrice" value="0" step="100000" style="width:180px;font-size:18px;font-weight:700;text-align:right;" onchange="autoSave();">
                        <span style="font-size:14px;color:#4a5568;">원 (VAT별도)</span>
                    </div>
                    <div class="result-sub" id="csAgentDiscount"></div>
                </div>
            </div>
        </div>

        <!-- ===== CS쉐어링 전용: 콜 조건 ===== -->
        <div class="for-cs-share">
            <div class="card">
                <div class="card-title">CS쉐어링 조건</div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">월 기본 콜수 (건)</label>
                        <input type="number" id="shareBaseCall" value="500" step="50" onchange="calcCSShare(); autoSave();">
                    </div>
                    <div class="form-group">
                        <label class="form-label">월 기본료 (원)</label>
                        <input type="number" id="shareBaseFee" value="500000" step="50000" onchange="calcCSShare(); autoSave();">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">초과 건당 단가 (원)</label>
                        <input type="number" id="sharePerCall" value="1000" step="100" onchange="calcCSShare(); autoSave();">
                    </div>
                    <div class="form-group">
                        <label class="form-label">통신비용</label>
                        <select id="shareComm" onchange="autoSave();">
                            <option value="실비청구">아웃콜 실비 청구</option>
                            <option value="포함">기본료에 포함</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">운영시간</label>
                        <input type="text" id="shareOpTime" value="평일 09:00~18:00" oninput="autoSave();">
                    </div>
                    <div class="form-group">
                        <label class="form-label">초기 구축비 (원)</label>
                        <input type="number" id="shareSetupFee" value="0" step="100000" onchange="autoSave();">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">CS 쉐어 월 콜 기준</label>
                    <input type="text" id="shareCallStandard" value="" placeholder="예: 월 500건 기준" oninput="autoSave();">
                </div>

                <div class="form-group">
                    <label class="form-label">업무범위</label>
                    <textarea id="shareWorkScope" rows="3" placeholder="예: 인바운드 CS 응대, 주문/교환/반품 안내" oninput="autoSave();"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">포함 서비스</label>
                    <textarea id="shareServices" rows="2" placeholder="예: 녹취 및 시스템 이용료 포함, DB 제공 (주간/월간 보고서)" oninput="autoSave();">녹취 및 시스템 이용료 포함, DB 제공 (주간/월간 보고서)</textarea>
                </div>
            </div>

            <div class="card">
                <div class="card-title">CS쉐어링 비용 산출</div>
                <table class="data-table">
                    <thead><tr><th>항목</th><th style="text-align:right;">단가</th><th style="text-align:right;">금액</th><th>비고</th></tr></thead>
                    <tbody id="csShareCostDetail"></tbody>
                    <tfoot>
                        <tr><td><strong>합계 (VAT별도)</strong></td><td></td><td class="num" id="csShareTotal" style="font-size:16px;">-</td><td></td></tr>
                    </tfoot>
                </table>

                <div class="result-box" style="margin-top:16px;">
                    <div class="result-title">최종 제안가</div>
                    <div style="display:flex;gap:16px;align-items:center;">
                        <input type="number" id="csShareFinalPrice" value="0" step="50000" style="width:180px;font-size:18px;font-weight:700;text-align:right;" onchange="autoSave();">
                        <span style="font-size:14px;color:#4a5568;">원/월 (VAT별도)</span>
                    </div>
                    <div class="result-sub" id="csShareDiscount"></div>
                </div>
            </div>
        </div>

        <!-- ===== 채용대행 전용: 직무별 인건비 ===== -->
        <div class="for-recruit">
            <div class="card">
                <div class="card-title">채용대행 조건</div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">운영시간</label>
                        <input type="text" id="recruitOpTime" value="09:00~18:00" oninput="autoSave();">
                    </div>
                    <div class="form-group">
                        <label class="form-label">인력 근무조건</label>
                        <input type="text" id="recruitWorkCond" value="주5일 / 일 8시간 근무" oninput="autoSave();">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">업무범위</label>
                    <textarea id="recruitWorkScope" rows="2" oninput="autoSave();">채용대행(구인 및 지원자 이력서 전달)</textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">소개수수료율 (%)</label>
                    <input type="number" id="recruitFeeRate" value="8" step="1" min="1" max="30" onchange="calcRecruit(); autoSave();">
                </div>

                <div class="form-group">
                    <label class="form-label">최소 수수료 청구기간 (개월)</label>
                    <input type="number" id="recruitMinMonth" value="3" step="1" min="1" max="12" onchange="autoSave();">
                </div>
            </div>

            <div class="card">
                <div class="card-title">직무별 인건비 <button class="rate-toggle" onclick="addRecruitRow()">+ 직무 추가</button></div>

                <table class="data-table" id="recruitTable">
                    <thead>
                        <tr>
                            <th>직무명</th>
                            <th style="text-align:center;">경력구분</th>
                            <th style="text-align:right;">월 급여 (원)</th>
                            <th style="text-align:right;">인원</th>
                            <th style="text-align:right;">합계</th>
                            <th style="width:40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="recruitRows">
                        <tr>
                            <td><input type="text" value="대리점관리파트" style="width:100%;padding:4px;" onchange="calcRecruit(); autoSave();"></td>
                            <td style="text-align:center;"><select style="padding:4px;" onchange="calcRecruit(); autoSave();"><option>신입</option><option>경력</option></select></td>
                            <td><input type="number" value="2500000" step="100000" style="width:100%;text-align:right;padding:4px;" onchange="calcRecruit(); autoSave();"></td>
                            <td><input type="number" value="1" min="1" max="50" style="width:60px;text-align:center;padding:4px;" onchange="calcRecruit(); autoSave();"></td>
                            <td class="num" style="font-weight:600;">-</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="통화품질 담당" style="width:100%;padding:4px;" onchange="calcRecruit(); autoSave();"></td>
                            <td style="text-align:center;"><select style="padding:4px;" onchange="calcRecruit(); autoSave();"><option>신입</option><option selected>경력</option></select></td>
                            <td><input type="number" value="2670000" step="100000" style="width:100%;text-align:right;padding:4px;" onchange="calcRecruit(); autoSave();"></td>
                            <td><input type="number" value="1" min="1" max="50" style="width:60px;text-align:center;padding:4px;" onchange="calcRecruit(); autoSave();"></td>
                            <td class="num" style="font-weight:600;">-</td>
                            <td><button onclick="removeRecruitRow(this)" style="background:none;border:none;color:#e53e3e;cursor:pointer;font-size:16px;">&times;</button></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>① 인건비 소계</strong></td>
                            <td class="num" id="recruitTotalPeople">-</td>
                            <td class="num" id="recruitLaborTotal" style="font-size:15px;">-</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="4"><strong>② 소개수수료 (<span id="recruitFeeRateDisplay">8</span>%)</strong></td>
                            <td class="num" id="recruitFeeTotal">-</td>
                            <td></td>
                        </tr>
                        <tr style="background:#f0f5ff;">
                            <td colspan="4"><strong>합계 (①+②) (VAT 별도)</strong></td>
                            <td class="num" id="recruitGrandTotal" style="font-size:16px;font-weight:700;color:#1a365d;">-</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>

                <div class="result-box" style="margin-top:16px;">
                    <div class="result-title">최종 제안가</div>
                    <div style="display:flex;gap:16px;align-items:center;">
                        <input type="number" id="recruitFinalPrice" value="0" step="10000" style="width:180px;font-size:18px;font-weight:700;text-align:right;" onchange="autoSave();">
                        <span style="font-size:14px;color:#4a5568;">원/월 (VAT별도)</span>
                    </div>
                    <div class="result-sub" id="recruitDiscount"></div>
                </div>
            </div>
        </div>

        <!-- ===== 도급 공통 (정액제/일반): 현장조건 ===== -->
        <div class="for-dogup">
        <div class="card">
            <div class="card-title">현장 조건 입력</div>

            <div class="form-group">
                <label class="form-label">근무 패턴</label>
                <div class="option-group">
                    <button class="option-btn selected" onclick="applyShiftPreset('service', this)">서비스업</button>
                    <button class="option-btn" onclick="applyShiftPreset('mfg2', this)">제조 주야2교대</button>
                    <button class="option-btn" onclick="applyShiftPreset('mfg12', this)">제조 12시간</button>
                    <button class="option-btn" onclick="applyShiftPreset('mfg3', this)">3교대</button>
                    <button class="option-btn" onclick="applyShiftPreset('custom', this)">커스텀</button>
                </div>
                <div id="presetDesc" style="font-size:11px; color:#a0aec0; margin-top:6px;">영업시간을 교대로 나누어 커버</div>
            </div>

            <div class="form-group">
                <label class="form-label">교대조 시간표</label>
                <table class="data-table" style="margin:0;">
                    <thead>
                        <tr>
                            <th style="width:70px;">교대조</th>
                            <th>시작</th>
                            <th>종료</th>
                            <th>잔업종료 <span style="font-weight:400;color:#a0aec0;">(선택)</span></th>
                            <th style="width:80px;text-align:right;">시간</th>
                        </tr>
                    </thead>
                    <tbody id="shiftTableBody">
                        <tr>
                            <td style="font-weight:600;color:#1a365d;">1교대</td>
                            <td><input type="text" id="s1Start" value="08:00" style="width:70px;text-align:center;padding:4px;" onchange="calcPersonnel(); autoSave();"></td>
                            <td><input type="text" id="s1End" value="15:30" style="width:70px;text-align:center;padding:4px;" onchange="calcPersonnel(); autoSave();"></td>
                            <td><input type="text" id="s1OT" value="" placeholder="-" style="width:70px;text-align:center;padding:4px;color:#ed8936;" onchange="calcPersonnel(); autoSave();"></td>
                            <td class="num" id="s1Hours">7.5h</td>
                        </tr>
                        <tr>
                            <td style="font-weight:600;color:#1a365d;">2교대</td>
                            <td><input type="text" id="s2Start" value="15:30" style="width:70px;text-align:center;padding:4px;" onchange="calcPersonnel(); autoSave();"></td>
                            <td><input type="text" id="s2End" value="23:00" style="width:70px;text-align:center;padding:4px;" onchange="calcPersonnel(); autoSave();"></td>
                            <td><input type="text" id="s2OT" value="" placeholder="-" style="width:70px;text-align:center;padding:4px;color:#ed8936;" onchange="calcPersonnel(); autoSave();"></td>
                            <td class="num" id="s2Hours">7.5h</td>
                        </tr>
                        <tr id="shift3Row" style="display:none;">
                            <td style="font-weight:600;color:#1a365d;">3교대</td>
                            <td><input type="text" id="s3Start" value="" style="width:70px;text-align:center;padding:4px;" onchange="calcPersonnel(); autoSave();"></td>
                            <td><input type="text" id="s3End" value="" style="width:70px;text-align:center;padding:4px;" onchange="calcPersonnel(); autoSave();"></td>
                            <td><input type="text" id="s3OT" value="" placeholder="-" style="width:70px;text-align:center;padding:4px;color:#ed8936;" onchange="calcPersonnel(); autoSave();"></td>
                            <td class="num" id="s3Hours">-</td>
                        </tr>
                    </tbody>
                </table>
                <div style="font-size:11px; color:#a0aec0; margin-top:4px;">시간은 HH:MM 형식. 야간(익일) = 24시 이후로 입력 (예: 05:00 → 29:00)</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">주간 운영일</label>
                    <div class="option-group">
                        <button class="option-btn" onclick="selectOption(this,'opDays'); autoSave();">주1일</button>
                        <button class="option-btn" onclick="selectOption(this,'opDays'); autoSave();">주2일</button>
                        <button class="option-btn" onclick="selectOption(this,'opDays'); autoSave();">주3일</button>
                        <button class="option-btn" onclick="selectOption(this,'opDays'); autoSave();">주4일</button>
                        <button class="option-btn" onclick="selectOption(this,'opDays'); autoSave();">주5일</button>
                        <button class="option-btn" onclick="selectOption(this,'opDays'); autoSave();">주6일</button>
                        <button class="option-btn selected" onclick="selectOption(this,'opDays'); autoSave();">주7일</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">교대당 필요 인원</label>
                    <input type="number" id="perShift" value="4" min="1" max="50" onchange="calcPersonnel(); autoSave();">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">현장관리자 <span class="hint">(별도)</span></label>
                <div class="option-group">
                    <button class="option-btn selected" onclick="selectOption(this,'manager'); autoSave();">1명 배치</button>
                    <button class="option-btn" onclick="selectOption(this,'manager'); autoSave();">미배치</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">인원 산출 결과</div>

            <div class="result-box">
                <div class="result-title">산출 인원 (내부용 — 견적서에 절대 노출 금지)</div>
                <div style="display:flex; gap: 30px; align-items:flex-end;">
                    <div>
                        <div class="result-value" id="totalPersonnel">12명</div>
                        <div class="result-sub" id="personnelFormula">4명 × 2교대 × 7일 ÷ 5일 = 11.2 → 12명</div>
                    </div>
                    <div id="managerInfo" style="font-size:13px; color:#4a5568;">
                        + 현장관리자 1명
                    </div>
                </div>
            </div>

            <table class="data-table" style="margin-top:16px;">
                <thead>
                    <tr><th>항목</th><th style="text-align:right;">수치</th></tr>
                </thead>
                <tbody id="personnelDetail">
                </tbody>
            </table>

            <div class="alert alert-warning" style="margin-top:16px;">
                <span>&#9888;</span>
                <span>이 인원수는 내부 원가계산용입니다. 견적서·고객 대화에서 절대 언급하지 마세요.</span>
            </div>
        </div>

        </div><!-- /for-dogup -->

        <!-- 일반도급 전용: 관리수수료 설정 -->
        <div class="for-labor">
            <div class="card">
                <div class="card-title">일반 도급 추가 설정</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">관리수수료 (%)</label>
                        <input type="number" id="laborMgmtFee" value="8" step="1" min="0" max="30" onchange="calcCost(); autoSave();">
                    </div>
                    <div class="form-group">
                        <label class="form-label">교통비 (인당/월)</label>
                        <input type="number" id="laborTransport" value="100000" step="10000" onchange="calcCost(); autoSave();">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">직책수당 (현장관리자)</label>
                        <input type="number" id="laborLeaderPay" value="100000" step="10000" onchange="calcCost(); autoSave();">
                    </div>
                    <div class="form-group">
                        <label class="form-label">사업소세 (%)</label>
                        <input type="number" id="laborBizTax" value="0.5" step="0.1" min="0" onchange="calcCost(); autoSave();">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">장기요양보험 (건강보험료 대비 %)</label>
                    <input type="number" id="laborLongCare" value="13.14" step="0.01" min="0" onchange="calcCost(); autoSave();">
                </div>
            </div>
        </div>

        <div class="btn-group" style="justify-content:space-between;">
            <button class="btn btn-secondary" onclick="switchTab(0)">&larr; 고객정보</button>
            <button class="btn btn-primary" onclick="switchTab(2)">다음: 원가계산 &rarr;</button>
        </div>
    </div>

    <!-- ==================== 탭3: 원가계산 ==================== -->
    <div class="tab-content" id="tab2">

        <!-- CS대행/쉐어링/채용대행은 Tab2에서 비용 산출까지 완료 → Tab3은 건너뜀 안내 -->
        <div class="for-cs">
            <div class="card">
                <div class="alert alert-info">
                    <span>&#128161;</span>
                    <span>CS 견적은 이전 탭에서 비용 산출이 완료되었습니다. <strong>견적서생성</strong>으로 이동하세요.</span>
                </div>
                <div class="btn-group" style="justify-content:center;">
                    <button class="btn btn-primary" onclick="switchTab(4)">견적서 생성으로 이동 &rarr;</button>
                </div>
            </div>
        </div>
        <div class="for-recruit">
            <div class="card">
                <div class="alert alert-info">
                    <span>&#128161;</span>
                    <span>채용대행 견적은 이전 탭에서 비용 산출이 완료되었습니다. <strong>견적서생성</strong>으로 이동하세요.</span>
                </div>
                <div class="btn-group" style="justify-content:center;">
                    <button class="btn btn-primary" onclick="switchTab(4)">견적서 생성으로 이동 &rarr;</button>
                </div>
            </div>
        </div>

        <div class="for-dogup">
        <div class="card">
            <div class="card-title">인건비 계산</div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">시급 (원)</label>
                    <input type="number" id="hourlyWage" value="10500" step="100" min="10320" onchange="calcCost(); autoSave();">
                    <div style="font-size:11px; color:#a0aec0; margin-top:4px;">2026년 최저시급: 10,320원</div>
                </div>
                <div class="form-group">
                    <label class="form-label">기본급 (자동계산)</label>
                    <div class="result-box" style="padding:10px 14px;">
                        <span id="baseWage" style="font-size:18px; font-weight:600;">2,194,500원</span>
                        <div class="result-sub">시급 × 209시간</div>
                    </div>
                </div>
            </div>

            <div style="margin-top:8px;">
                <span style="font-size:13px; font-weight:600; color:#4a5568;">요율 설정</span>
                <button class="rate-toggle" onclick="toggleRates()">수정하기</button>
                <div class="rate-settings" id="rateSettings">
                    <div style="font-size:11px; color:#a0aec0; margin-bottom:8px;">업종/연도에 따라 요율이 다릅니다. 필요 시 수정하세요.</div>
                    <div class="rate-row">
                        <div class="rate-item">
                            <span>국민연금</span>
                            <input type="number" id="ratePension" value="4.5" step="0.1" onchange="calcCost(); autoSave();">
                            <span>%</span>
                        </div>
                        <div class="rate-item">
                            <span>건강보험</span>
                            <input type="number" id="rateHealth" value="3.545" step="0.001" onchange="calcCost(); autoSave();">
                            <span>%</span>
                        </div>
                        <div class="rate-item">
                            <span>고용보험</span>
                            <input type="number" id="rateEmploy" value="0.9" step="0.1" onchange="calcCost(); autoSave();">
                            <span>%</span>
                        </div>
                        <div class="rate-item">
                            <span>산재보험</span>
                            <input type="number" id="rateIndust" value="1.5" step="0.1" onchange="calcCost(); autoSave();">
                            <span>%</span>
                        </div>
                        <div class="rate-item">
                            <span>퇴직금</span>
                            <input type="number" id="rateRetire" value="8.33" step="0.01" onchange="calcCost(); autoSave();">
                            <span>%</span>
                        </div>
                        <div class="rate-item">
                            <span>심야가산</span>
                            <input type="number" id="rateNight" value="50" step="5" onchange="calcPersonnel(); autoSave();">
                            <span>%</span>
                        </div>
                        <div class="rate-item">
                            <span>야간시작</span>
                            <input type="number" id="nightStart" value="22" step="1" min="18" max="24" onchange="calcPersonnel(); autoSave();">
                            <span>시</span>
                        </div>
                        <div class="rate-item">
                            <span>야간종료</span>
                            <input type="number" id="nightEnd" value="6" step="1" min="0" max="8" onchange="calcPersonnel(); autoSave();">
                            <span>시</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">원가 산출 상세</div>

            <table class="data-table">
                <thead>
                    <tr><th>항목</th><th style="text-align:right;">금액</th><th style="text-align:right;">비고</th></tr>
                </thead>
                <tbody id="costDetail">
                </tbody>
                <tfoot>
                    <tr>
                        <td><strong>총 원가</strong></td>
                        <td class="num" id="totalCost" style="font-size:16px;">-</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="card">
            <div class="card-title">기타 비용 조정</div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">야간수당 (월, 원) <span class="hint">22시 이후 근무 시</span></label>
                    <input type="number" id="nightPay" value="0" step="10000" onchange="calcCost(); autoSave();">
                </div>
                <div class="form-group">
                    <label class="form-label">기타비용 (월, 원) <span class="hint">유니폼/교육/채용 등</span></label>
                    <input type="number" id="etcCost" value="1000000" step="100000" onchange="calcCost(); autoSave();">
                </div>
            </div>
        </div>

        </div><!-- /for-dogup -->

        <div class="btn-group" style="justify-content:space-between;">
            <button class="btn btn-secondary" onclick="switchTab(1)">&larr; 인원산출</button>
            <button class="btn btn-primary" onclick="switchTab(3)">다음: 견적시뮬 &rarr;</button>
        </div>
    </div>

    <!-- ==================== 탭4: 견적시뮬레이션 ==================== -->
    <div class="tab-content" id="tab3">
        <div class="card">
            <div class="card-title">견적 금액 시뮬레이션</div>

            <div class="result-box" style="margin-bottom:20px;">
                <div class="result-title">총 원가 (기준)</div>
                <div class="result-value" id="simBaseCost">-</div>
            </div>

            <div class="scenario-cards">
                <div class="scenario-card primary">
                    <div class="scenario-label">첫 제시</div>
                    <div style="margin-bottom:8px;">
                        <input type="number" class="scenario-input" id="simQuote1" value="4500" onchange="updateScenarios(); autoSave();"> 만원
                    </div>
                    <div class="scenario-detail">이익: <strong id="simProfit1">-</strong></div>
                    <div class="scenario-detail">마진: <strong id="simMargin1">-</strong></div>
                </div>
                <div class="scenario-card secondary">
                    <div class="scenario-label">1차 양보</div>
                    <div style="margin-bottom:8px;">
                        <input type="number" class="scenario-input" id="simQuote2" value="4300" onchange="updateScenarios(); autoSave();"> 만원
                    </div>
                    <div class="scenario-detail">이익: <strong id="simProfit2">-</strong></div>
                    <div class="scenario-detail">마진: <strong id="simMargin2">-</strong></div>
                </div>
                <div class="scenario-card danger">
                    <div class="scenario-label">마지노선</div>
                    <div style="margin-bottom:8px;">
                        <input type="number" class="scenario-input" id="simQuote3" value="4000" onchange="updateScenarios(); autoSave();"> 만원
                    </div>
                    <div class="scenario-detail">이익: <strong id="simProfit3">-</strong></div>
                    <div class="scenario-detail">마진: <strong id="simMargin3">-</strong></div>
                </div>
            </div>
        </div>

        <div class="card for-outsource">
            <div class="card-title">항목 분배 (첫 제시 기준) — 정액제</div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">도급운영비 (만원)</label>
                    <input type="number" id="itemDogup" value="4000" step="100" onchange="updateItemTotal(); autoSave();">
                </div>
                <div class="form-group">
                    <label class="form-label">현장관리비 (만원)</label>
                    <input type="number" id="itemManage" value="300" step="50" onchange="updateItemTotal(); autoSave();">
                </div>
                <div class="form-group">
                    <label class="form-label">관리운영비 (만원)</label>
                    <input type="number" id="itemAdmin" value="200" step="50" onchange="updateItemTotal(); autoSave();">
                </div>
            </div>

            <div class="result-box" id="itemTotalBox">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div class="result-title">항목 합계</div>
                        <div id="itemTotal" style="font-size:20px; font-weight:700;">4,500만원</div>
                    </div>
                    <div id="itemMismatch" style="display:none; color:#e53e3e; font-size:13px; font-weight:600;">
                        &#9888; 첫 제시 금액과 불일치
                    </div>
                </div>
            </div>

            <div class="alert alert-info" style="margin-top:12px;">
                <span>&#128161;</span>
                <span><strong>팁:</strong> 협상 시 관리비(현장관리비+관리운영비)는 지키고 도급운영비에서 조정하세요.</span>
            </div>
        </div>

        <div class="btn-group" style="justify-content:space-between;">
            <button class="btn btn-secondary" onclick="switchTab(2)">&larr; 원가계산</button>
            <button class="btn btn-primary" onclick="switchTab(4)">다음: 견적서 생성 &rarr;</button>
        </div>
    </div>

    <!-- ==================== 탭5: 견적서 생성 ==================== -->
    <div class="tab-content" id="tab4">
        <div class="card">
            <div class="card-title">견적서 정보</div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">견적번호</label>
                    <input type="text" id="quoteNumber" oninput="autoSave()">
                </div>
                <div class="form-group">
                    <label class="form-label">견적일자</label>
                    <input type="text" id="quoteDate" oninput="autoSave()">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">업무 범위 <span class="hint">(한 줄씩 입력)</span></label>
                <textarea id="workScope" rows="4" placeholder="예:&#10;드라잉존 물기 제거 작업&#10;입차 유도 및 고객 차량 안내&#10;고객 응대 및 안내 서비스" oninput="autoSave()"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">추가 특기사항 <span class="hint">(기본 내용에 추가됩니다 / 한 줄씩 입력)</span></label>
                <textarea id="quoteNotes" rows="4" placeholder="예:&#10;본 견적은 주 7일 운영 기준&#10;서비스 교육 이수자 우선 배치&#10;야간수당 도급비에 포함" oninput="autoSave()"></textarea>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn btn-success" onclick="generateQuote()">견적서 생성 및 미리보기</button>
            <button class="btn btn-primary" onclick="printQuote()">PDF 인쇄 (Ctrl+P)</button>
        </div>

        <div id="quotePreview" style="margin-top:20px;"></div>

        <div class="btn-group" style="justify-content:space-between; margin-top:20px;">
            <button class="btn btn-secondary" onclick="switchTab(3)">&larr; 견적시뮬</button>
            <button class="btn btn-primary" onclick="switchTab(5)">다음: 체크리스트 &rarr;</button>
        </div>
    </div>

    <!-- ==================== 탭6: 체크리스트 ==================== -->
    <div class="tab-content" id="tab5">
        <div class="card">
            <div class="card-title">견적 워크플로우 체크리스트</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
            <div style="text-align:right; font-size:12px; color:#718096; margin-bottom:16px;" id="progressText">0 / 10 완료</div>

            <ul class="checklist" id="checklist">
                <li onclick="toggleCheck(this)">
                    <div class="check-box"></div>
                    <div><span class="check-step">1단계</span><span class="check-text">고객 사전조사 완료</span></div>
                </li>
                <li onclick="toggleCheck(this)">
                    <div class="check-box"></div>
                    <div><span class="check-step">2단계</span><span class="check-text">현장 정보 파악 완료</span></div>
                </li>
                <li onclick="toggleCheck(this)">
                    <div class="check-box"></div>
                    <div><span class="check-step">3단계</span><span class="check-text">인원 산출 완료 (내부용)</span></div>
                </li>
                <li onclick="toggleCheck(this)">
                    <div class="check-box"></div>
                    <div><span class="check-step">4단계</span><span class="check-text">원가 계산 완료</span></div>
                </li>
                <li onclick="toggleCheck(this)">
                    <div class="check-box"></div>
                    <div><span class="check-step">5단계</span><span class="check-text">견적 금액 결정 (마진 확인)</span></div>
                </li>
                <li onclick="toggleCheck(this)">
                    <div class="check-box"></div>
                    <div><span class="check-step">6단계</span><span class="check-text">견적서 작성 & PDF 변환</span></div>
                </li>
                <li onclick="toggleCheck(this)">
                    <div class="check-box"></div>
                    <div><span class="check-step">7단계</span><span class="check-text">메일 발송 완료</span></div>
                </li>
                <li onclick="toggleCheck(this)">
                    <div class="check-box"></div>
                    <div><span class="check-step">8단계</span><span class="check-text">팔로업 (읽음 확인 → 전화)</span></div>
                </li>
                <li onclick="toggleCheck(this)">
                    <div class="check-box"></div>
                    <div><span class="check-step">9단계</span><span class="check-text">협상 대응 완료</span></div>
                </li>
                <li onclick="toggleCheck(this)">
                    <div class="check-box"></div>
                    <div><span class="check-step">10단계</span><span class="check-text">계약 체결 → 현장 투입</span></div>
                </li>
            </ul>
        </div>

        <div class="card">
            <div class="card-title">결과 기록</div>
            <div class="form-group">
                <label class="form-label">최종 결과</label>
                <div class="option-group">
                    <button class="option-btn" onclick="selectOption(this,'result'); autoSave();" style="border-color:#38a169; color:#38a169;">Win (계약성사)</button>
                    <button class="option-btn" onclick="selectOption(this,'result'); autoSave();" style="border-color:#e53e3e; color:#e53e3e;">Loss (미성사)</button>
                    <button class="option-btn" onclick="selectOption(this,'result'); autoSave();" style="border-color:#ed8936; color:#ed8936;">Pending (진행중)</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">최종 계약가 (만원)</label>
                <input type="number" id="finalPrice" oninput="autoSave()">
            </div>
            <div class="form-group">
                <label class="form-label">교훈 / 메모</label>
                <textarea id="lessonMemo" rows="3" placeholder="이번 건에서 배운 점..." oninput="autoSave()"></textarea>
            </div>
        </div>

        <div class="btn-group" style="justify-content:flex-start;">
            <button class="btn btn-secondary" onclick="switchTab(4)">&larr; 견적서생성</button>
        </div>
    </div>

</div>

<!-- ===== 이력 모달 ===== -->
<div class="modal-overlay" id="historyModal" onclick="if(event.target===this)closeHistory()">
    <div class="modal">
        <div class="modal-header">
            <h2>견적 이력</h2>
            <button class="modal-close" onclick="closeHistory()">&times;</button>
        </div>
        <div class="modal-body" id="historyList"></div>
        <div class="modal-footer">
            <span style="font-size:11px;color:#a0aec0;">최대 50건 저장 | 브라우저 localStorage 기반</span>
        </div>
    </div>
</div>

<script>
// ===== 전역 상태 =====
let state = {
    quoteType: 'outsource',
    source: '', currentOps: '', opDays: '주7일', shifts: '2교대',
    manager: '1명 배치', result: '',
    checklist: [false,false,false,false,false,false,false,false,false,false]
};

// ===== 탭 전환 =====
function switchTab(idx) {
    document.querySelectorAll('.tab-content').forEach((el,i) => {
        el.classList.toggle('active', i === idx);
    });
    document.querySelectorAll('.tab-btn').forEach((el,i) => {
        el.classList.toggle('active', i === idx);
    });

    // 탭 전환 시 자동 계산
    if (idx === 1) calcPersonnel();
    if (idx === 2) calcCost();
    if (idx === 3) { updateScenarios(); updateItemTotal(); }
}

// ===== 옵션 버튼 선택 =====
function selectOption(btn, group) {
    btn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    state[group] = btn.textContent.trim();

    if (group === 'opDays' || group === 'shifts' || group === 'manager') {
        calcPersonnel();
    }
    autoSave();
}

// ===== 견적 유형 전환 =====
function switchQuoteType(type, card) {
    // 버튼 표시
    document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
    if (card) card.classList.add('selected');

    state.quoteType = type;

    // body 클래스로 유형별 표시 제어
    document.body.className = 'qt-' + type;

    // 탭 라벨 변경
    const tabLabels = {
        outsource: ['고객정보','인원산출','원가계산','견적시뮬','견적서생성','체크리스트'],
        labor:     ['고객정보','인원산출','원가계산','견적시뮬','견적서생성','체크리스트'],
        'cs-agent':['고객정보','상담사구성','(건너뜀)','(건너뜀)','견적서생성','체크리스트'],
        'cs-share':['고객정보','콜조건','(건너뜀)','(건너뜀)','견적서생성','체크리스트'],
        recruit:   ['고객정보','직무구성','(건너뜀)','(건너뜀)','견적서생성','체크리스트']
    };
    const labels = tabLabels[type] || tabLabels.outsource;
    document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        const numEl = btn.querySelector('.tab-num');
        const text = btn.childNodes[btn.childNodes.length - 1];
        if (text && text.nodeType === 3) text.textContent = labels[i];
    });

    autoSave();
}

// ===== CS대행 비용 계산 =====
function calcCSAgent() {
    const seniorN = parseInt(document.getElementById('csSeniorCount').value) || 0;
    const seniorS = parseInt(document.getElementById('csSeniorSalary').value) || 0;
    const juniorN = parseInt(document.getElementById('csJuniorCount').value) || 0;
    const juniorS = parseInt(document.getElementById('csJuniorSalary').value) || 0;
    const asp = parseInt(document.getElementById('csASP').value) || 0;
    const mgmtPct = parseFloat(document.getElementById('csMgmtFee').value) || 8;

    const totalPeople = seniorN + juniorN;
    const laborCost = seniorN * seniorS + juniorN * juniorS;
    const aspCost = asp * totalPeople;
    const subtotal = laborCost + aspCost;
    const mgmtCost = Math.round(subtotal * mgmtPct / 100);
    const total = subtotal + mgmtCost;

    let html = '';
    if (seniorN > 0) html += '<tr><td>선임 상담사</td><td class="num">' + fmt(seniorS) + '</td><td class="num">' + seniorN + '</td><td class="num">' + fmt(seniorN * seniorS) + '</td></tr>';
    if (juniorN > 0) html += '<tr><td>일반 상담사</td><td class="num">' + fmt(juniorS) + '</td><td class="num">' + juniorN + '</td><td class="num">' + fmt(juniorN * juniorS) + '</td></tr>';
    html += '<tr style="background:#f7fafc;"><td><strong>직·간접 노무비 소계</strong></td><td></td><td class="num">' + totalPeople + '</td><td class="num highlight">' + fmt(laborCost) + '</td></tr>';
    html += '<tr><td>ASP 패키지</td><td class="num">' + fmt(asp) + '</td><td class="num">' + totalPeople + '</td><td class="num">' + fmt(aspCost) + '</td></tr>';
    html += '<tr><td>원 운영비 (발신비용)</td><td colspan="2" style="text-align:right;color:#718096;">실비 청구</td><td class="num">-</td></tr>';
    html += '<tr style="background:#f7fafc;"><td><strong>합계 (①+②)</strong></td><td></td><td></td><td class="num highlight">' + fmt(subtotal) + '</td></tr>';
    html += '<tr><td>관리수수료 (' + mgmtPct + '%)</td><td></td><td></td><td class="num">' + fmt(mgmtCost) + '</td></tr>';

    document.getElementById('csAgentCostDetail').innerHTML = html;
    document.getElementById('csAgentTotal').textContent = fmt(total) + '원';

    // 최종 제안가 자동 세팅 (처음만)
    const fp = document.getElementById('csAgentFinalPrice');
    if (!state._csAgentManual) {
        fp.value = Math.ceil(total / 100000) * 100000; // 10만원 단위 올림
    }

    const finalP = parseInt(fp.value) || 0;
    const diff = total - finalP;
    document.getElementById('csAgentDiscount').textContent =
        finalP < total ? '할인: ' + fmt(total - finalP) + '원 (' + ((total - finalP)/total*100).toFixed(1) + '%)' :
        finalP > total ? '마진: +' + fmt(finalP - total) + '원' : '원가 동일';

    state.csAgentTotal = total;
}

// ===== CS쉐어링 비용 계산 =====
function calcCSShare() {
    const baseFee = parseInt(document.getElementById('shareBaseFee').value) || 0;
    const baseCall = parseInt(document.getElementById('shareBaseCall').value) || 0;
    const perCall = parseInt(document.getElementById('sharePerCall').value) || 0;
    const comm = document.getElementById('shareComm').value;

    let html = '';
    html += '<tr><td>기본료</td><td class="num">' + fmt(baseFee) + '</td><td class="num">' + fmt(baseFee) + '</td><td>월 ' + baseCall + '건 기준</td></tr>';
    html += '<tr><td>콜 단가 (초과분)</td><td class="num">' + fmt(perCall) + '/건</td><td class="num">-</td><td>월 ' + baseCall + '건 초과 시</td></tr>';
    html += '<tr><td>통신 비용</td><td></td><td class="num">-</td><td>' + (comm === '실비청구' ? '아웃콜 실비 발생 시 청구' : '기본료 포함') + '</td></tr>';

    document.getElementById('csShareCostDetail').innerHTML = html;
    document.getElementById('csShareTotal').textContent = fmt(baseFee) + '원~';

    const fp = document.getElementById('csShareFinalPrice');
    if (!state._csShareManual) fp.value = baseFee;

    state.csShareBaseFee = baseFee;
}

// ===== 채용대행 비용 계산 =====
function calcRecruit() {
    const rows = document.getElementById('recruitRows').querySelectorAll('tr');
    const feeRate = parseFloat(document.getElementById('recruitFeeRate').value) || 8;
    let totalPeople = 0;
    let totalLabor = 0;

    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (inputs.length < 3) return;
        const salary = parseInt(inputs[1].value) || 0;
        const count = parseInt(inputs[2].value) || 0;
        const subtotal = salary * count;
        totalPeople += count;
        totalLabor += subtotal;
        // 합계 셀 업데이트
        const tds = row.querySelectorAll('td');
        tds[4].textContent = fmt(subtotal);
    });

    const fee = Math.round(totalLabor * feeRate / 100);
    const grandTotal = totalLabor + fee;

    document.getElementById('recruitTotalPeople').textContent = totalPeople;
    document.getElementById('recruitLaborTotal').textContent = fmt(totalLabor);
    document.getElementById('recruitFeeRateDisplay').textContent = feeRate;
    document.getElementById('recruitFeeTotal').textContent = fmt(fee);
    document.getElementById('recruitGrandTotal').textContent = fmt(grandTotal);

    // 최종 제안가 자동 세팅
    const fp = document.getElementById('recruitFinalPrice');
    if (!state._recruitManual) {
        fp.value = grandTotal;
    }

    const finalP = parseInt(fp.value) || 0;
    document.getElementById('recruitDiscount').textContent =
        finalP < grandTotal ? '할인: ' + fmt(grandTotal - finalP) + '원' :
        finalP > grandTotal ? '마진: +' + fmt(finalP - grandTotal) + '원' : '원가 동일';

    state.recruitTotal = grandTotal;
}

function addRecruitRow(job, career, salary, count) {
    const tbody = document.getElementById('recruitRows');
    const tr = document.createElement('tr');
    const jobVal = job || '';
    const careerVal = career || '신입';
    const salaryVal = salary || '2500000';
    const countVal = count || '1';
    tr.innerHTML = `<td><input type="text" value="${jobVal}" placeholder="직무명" style="width:100%;padding:4px;" onchange="calcRecruit(); autoSave();"></td>
        <td style="text-align:center;"><select style="padding:4px;" onchange="calcRecruit(); autoSave();"><option${careerVal==='신입'?' selected':''}>신입</option><option${careerVal==='경력'?' selected':''}>경력</option></select></td>
        <td><input type="number" value="${salaryVal}" step="100000" style="width:100%;text-align:right;padding:4px;" onchange="calcRecruit(); autoSave();"></td>
        <td><input type="number" value="${countVal}" min="1" max="50" style="width:60px;text-align:center;padding:4px;" onchange="calcRecruit(); autoSave();"></td>
        <td class="num" style="font-weight:600;">-</td>
        <td><button onclick="removeRecruitRow(this)" style="background:none;border:none;color:#e53e3e;cursor:pointer;font-size:16px;">&times;</button></td>`;
    tbody.appendChild(tr);
    calcRecruit();
}

function removeRecruitRow(btn) {
    const tbody = document.getElementById('recruitRows');
    if (tbody.querySelectorAll('tr').length <= 1) {
        alert('최소 1개 직무는 필요합니다.');
        return;
    }
    btn.closest('tr').remove();
    calcRecruit();
    autoSave();
}

// ===== 업종 선택 시 팁 =====
function onIndustryChange() {
    const v = document.getElementById('industry').value;
    const tip = document.getElementById('industryTip');
    const tips = {
        '세차/주차': '시급 10,320~11,000원. 서비스 마인드 필요. 추천: 정액제 도급 / 일반 도급',
        '물류/택배': '야간 많음, 수당 비중 높음. 시급 10,500~12,000원. 추천: 일반 도급 / 정액제 도급',
        '제조라인': '불법파견 주의! 적법운영안내서 함께 제출 권장. 시급 10,500~13,000원. 추천: 정액제 도급',
        '사무/행정': '주간 운영, 전문성에 따라 편차. 마진 여유 높음. 추천: 정액제 도급 / 채용대행',
        'CS/콜센터': 'ASP 인프라 포함. AI 답변 시스템 연동 가능. 추천: CS대행 / CS쉐어링',
        '이커머스': 'CS 외주로 마케팅·상품 집중. 소규모 셀러 최적. 추천: CS쉐어링 / CS대행',
        '경비/시설': '24시간 격일근무 가능. 시급 10,320~11,000원. 추천: 정액제 도급',
        '호텔/숙박': '서비스 마인드 필수. 시급 10,500~12,000원. 추천: 정액제 도급',
        '식품제조': 'HACCP 위생관리 필수. 불법파견 주의. 시급 10,320~11,500원. 추천: 정액제 도급'
    };
    if (tips[v]) {
        tip.style.display = 'flex';
        tip.innerHTML = '<span>&#128161;</span><span><strong>' + v + ':</strong> ' + tips[v] + '</span>';
    } else {
        tip.style.display = 'none';
    }
}

// ===== 시간 파싱 유틸 =====
function parseTime(str) {
    // "HH:MM" 또는 "HH" → 시간(소수)으로 변환
    if (!str || str.trim() === '' || str.trim() === '-') return null;
    const parts = str.trim().split(':');
    const h = parseInt(parts[0]) || 0;
    const m = parseInt(parts[1]) || 0;
    return h + m / 60;
}

function fmtTime(decimal) {
    if (decimal === null || isNaN(decimal)) return '-';
    const h = Math.floor(decimal);
    const m = Math.round((decimal - h) * 60);
    return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
}

// ===== 교대 프리셋 =====
const shiftPresets = {
    service: {
        desc: '영업시간을 교대로 나누어 커버 (서비스업, 호텔, 세차 등)',
        shifts: 2, show3: false,
        s1: { start: '08:00', end: '15:30', ot: '' },
        s2: { start: '15:30', end: '23:00', ot: '' },
        s3: { start: '', end: '', ot: '' }
    },
    mfg2: {
        desc: '주간/야간 2교대 (제조, 물류). 잔업시간 별도 입력 가능',
        shifts: 2, show3: false,
        s1: { start: '08:00', end: '17:00', ot: '19:00' },
        s2: { start: '19:00', end: '29:00', ot: '31:00' },
        s3: { start: '', end: '', ot: '' }
    },
    mfg12: {
        desc: '12시간 주야 2교대 (제조, 물류)',
        shifts: 2, show3: false,
        s1: { start: '08:00', end: '20:00', ot: '' },
        s2: { start: '20:00', end: '32:00', ot: '' },
        s3: { start: '', end: '', ot: '' }
    },
    mfg3: {
        desc: '8시간 3교대 연속 운영 (24시간 공장)',
        shifts: 3, show3: true,
        s1: { start: '08:00', end: '16:00', ot: '' },
        s2: { start: '16:00', end: '24:00', ot: '' },
        s3: { start: '24:00', end: '32:00', ot: '' }
    },
    custom: {
        desc: '교대조별 시간을 직접 입력하세요',
        shifts: 2, show3: false,
        s1: { start: '', end: '', ot: '' },
        s2: { start: '', end: '', ot: '' },
        s3: { start: '', end: '', ot: '' }
    }
};

function applyShiftPreset(key, btn) {
    // 버튼 선택 표시
    btn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    state.shiftPreset = key;

    const preset = shiftPresets[key];
    document.getElementById('presetDesc').textContent = preset.desc;

    // 시간 필드 채우기
    ['s1','s2','s3'].forEach(s => {
        document.getElementById(s + 'Start').value = preset[s].start;
        document.getElementById(s + 'End').value = preset[s].end;
        document.getElementById(s + 'OT').value = preset[s].ot;
    });

    // 3교대 행 표시/숨김
    document.getElementById('shift3Row').style.display = preset.show3 ? '' : 'none';

    calcPersonnel();
    autoSave();
}

// ===== 인원 산출 =====
function calcPersonnel() {
    const perShift = parseInt(document.getElementById('perShift').value) || 4;
    const opDaysMap = { '주1일':1,'주2일':2,'주3일':3,'주4일':4,'주5일':5,'주6일':6,'주7일':7 };
    const opDays = opDaysMap[state.opDays] || 7;
    const hasManager = state.manager === '1명 배치';

    // 야간 인정 시간대 (설정값)
    const nightStartH = parseInt(document.getElementById('nightStart')?.value) || 22;
    const nightEndH = parseInt(document.getElementById('nightEnd')?.value) || 6;

    // 교대조별 시간 계산
    const shiftData = [];
    let totalWorkHours = 0;
    let totalNightHours = 0;
    let shiftCount = 0;

    [1,2,3].forEach(i => {
        const startStr = document.getElementById('s'+i+'Start').value;
        const endStr = document.getElementById('s'+i+'End').value;
        const otStr = document.getElementById('s'+i+'OT').value;

        const start = parseTime(startStr);
        const end = parseTime(endStr);
        const ot = parseTime(otStr);

        if (start !== null && end !== null && end > start) {
            const workH = end - start;
            const otH = (ot !== null && ot > end) ? ot - end : 0;
            const totalH = workH + otH;

            // 야간시간 계산 (22~30(=06) 범위의 시간 계산)
            let nightH = calcNightHours(start, end + otH, nightStartH, nightEndH);

            shiftData.push({ idx: i, start, end, ot, workH, otH, totalH, nightH });
            totalWorkHours += totalH;
            totalNightHours += nightH;
            shiftCount++;

            // 시간 표시 업데이트
            const hStr = totalH % 1 === 0 ? totalH + 'h' : totalH.toFixed(1) + 'h';
            document.getElementById('s'+i+'Hours').textContent = hStr + (nightH > 0 ? ' (야' + nightH.toFixed(1) + 'h)' : '');
        } else {
            document.getElementById('s'+i+'Hours').textContent = '-';
        }
    });

    if (shiftCount === 0) shiftCount = 2; // 기본값

    const dailyShifts = perShift * shiftCount;
    const rawPersonnel = dailyShifts * opDays / 5;
    const personnel = Math.ceil(rawPersonnel);

    // 전체 운영 시간 범위
    const firstStart = shiftData.length > 0 ? shiftData[0].start : 8;
    const lastEnd = shiftData.length > 0 ? shiftData[shiftData.length-1].end + (shiftData[shiftData.length-1].otH || 0) : 23;

    document.getElementById('totalPersonnel').textContent = personnel + '명';
    document.getElementById('personnelFormula').textContent =
        perShift + '명 × ' + shiftCount + '교대 × ' + opDays + '일 ÷ 5일 = ' +
        rawPersonnel.toFixed(1) + ' → ' + personnel + '명';

    document.getElementById('managerInfo').textContent =
        hasManager ? '+ 현장관리자 1명' : '(현장관리자 미배치)';

    // 상세 테이블
    let detailHTML = '';
    shiftData.forEach(s => {
        const label = s.idx + '교대';
        const timeStr = fmtTime(s.start) + '~' + fmtTime(s.end) + (s.otH > 0 ? ' (잔업~' + fmtTime(s.end + s.otH) + ')' : '');
        detailHTML += '<tr><td>' + label + '</td><td class="num">' + timeStr + ' / ' + s.totalH.toFixed(1) + 'h</td></tr>';
    });
    detailHTML += '<tr><td>운영일</td><td class="num">' + state.opDays + '</td></tr>';
    detailHTML += '<tr><td>일일 man-shifts</td><td class="num">' + dailyShifts + '</td></tr>';

    const nightStr = totalNightHours > 0
        ? nightStartH + ':00~' + (nightEndH < 10 ? '0' : '') + nightEndH + ':00 (일 ' + totalNightHours.toFixed(1) + 'h)'
        : '없음';
    detailHTML += '<tr><td>야간 시간대</td><td class="num">' + nightStr + '</td></tr>';
    detailHTML += '<tr><td><strong>산출 인원</strong></td><td class="num highlight"><strong>' + personnel + '명</strong></td></tr>';
    if (hasManager) {
        detailHTML += '<tr><td>현장관리자</td><td class="num">+1명 (별도)</td></tr>';
    }

    document.getElementById('personnelDetail').innerHTML = detailHTML;

    // 야간수당 자동 계산 (심야가산율 적용)
    const nightRate = (parseFloat(document.getElementById('rateNight').value) || 50) / 100;
    if (totalNightHours > 0) {
        const wage = parseInt(document.getElementById('hourlyWage').value) || 10500;
        const monthlyNight = Math.round(wage * nightRate * totalNightHours * personnel * opDays * 52 / 12);
        document.getElementById('nightPay').value = Math.round(monthlyNight / 10000) * 10000;
    } else {
        document.getElementById('nightPay').value = 0;
    }

    // 전역 저장
    state.personnel = personnel;
    state.nightHours = totalNightHours;
    state.shiftCount = shiftCount;
    state.shifts = shiftCount + '교대';
}

// 야간시간 계산 (24시간 기준 래핑 처리)
function calcNightHours(start, end, nightStart, nightEnd) {
    // nightStart=22, nightEnd=6 → 야간대 = 22~30(6+24)
    let nightH = 0;
    const ns = nightStart; // 22
    const ne = nightEnd + 24; // 30

    // shift가 일반 시간대일 때 (예: 8~17)
    // shift가 야간을 걸칠 때 (예: 19~29=05시)
    const overlapStart = Math.max(start, ns);
    const overlapEnd = Math.min(end, ne);
    if (overlapEnd > overlapStart) nightH += overlapEnd - overlapStart;

    // 24시를 넘는 경우 (다음날 야간 시작 전까지)
    // 예: start=24, end=32(=08) → 24~30 구간만 야간
    if (start >= 24) {
        // 이미 위에서 처리됨
    }

    return Math.max(0, nightH);
}

// ===== 원가 계산 =====
function calcCost() {
    const wage = parseInt(document.getElementById('hourlyWage').value) || 10500;
    const personnel = state.personnel || 12;
    const nightPay = parseInt(document.getElementById('nightPay').value) || 0;
    const etcCost = parseInt(document.getElementById('etcCost').value) || 0;

    // 요율 읽기 (조정 가능)
    const rPension = (parseFloat(document.getElementById('ratePension').value) || 4.5) / 100;
    const rHealth = (parseFloat(document.getElementById('rateHealth').value) || 3.545) / 100;
    const rEmploy = (parseFloat(document.getElementById('rateEmploy').value) || 0.9) / 100;
    const rIndust = (parseFloat(document.getElementById('rateIndust').value) || 1.5) / 100;
    const rRetire = (parseFloat(document.getElementById('rateRetire').value) || 8.33) / 100;

    const baseWage = wage * 209;
    const pension = Math.round(baseWage * rPension);
    const health = Math.round(baseWage * rHealth);
    const employ = Math.round(baseWage * rEmploy);
    const indust = Math.round(baseWage * rIndust);
    const insurance = pension + health + employ + indust;
    const retire = Math.round(baseWage * rRetire);
    const perPerson = baseWage + insurance + retire;
    const laborTotal = perPerson * personnel;
    const totalCost = laborTotal + nightPay + etcCost;

    // 배율 계산
    const multiplier = (perPerson / baseWage).toFixed(4);

    document.getElementById('baseWage').textContent = fmt(baseWage) + '원';

    let html = '';
    html += '<tr><td>기본급 (시급 × 209h)</td><td class="num">' + fmt(baseWage) + '원</td><td class="num">1인당</td></tr>';
    html += '<tr><td>&nbsp;&nbsp;국민연금 (' + (rPension*100).toFixed(1) + '%)</td><td class="num">' + fmt(pension) + '원</td><td class="num">1인당</td></tr>';
    html += '<tr><td>&nbsp;&nbsp;건강보험 (' + (rHealth*100).toFixed(3) + '%)</td><td class="num">' + fmt(health) + '원</td><td class="num">1인당</td></tr>';
    html += '<tr><td>&nbsp;&nbsp;고용보험 (' + (rEmploy*100).toFixed(1) + '%)</td><td class="num">' + fmt(employ) + '원</td><td class="num">1인당</td></tr>';
    html += '<tr><td>&nbsp;&nbsp;산재보험 (' + (rIndust*100).toFixed(1) + '%)</td><td class="num">' + fmt(indust) + '원</td><td class="num">1인당</td></tr>';
    html += '<tr><td>&nbsp;&nbsp;퇴직금충당 (' + (rRetire*100).toFixed(2) + '%)</td><td class="num">' + fmt(retire) + '원</td><td class="num">1인당</td></tr>';
    html += '<tr style="background:#f7fafc;"><td><strong>1인당 총비용</strong></td><td class="num highlight"><strong>' + fmt(perPerson) + '원</strong></td><td class="num">× ' + multiplier + '</td></tr>';
    html += '<tr><td>인건비 소계 (' + personnel + '명)</td><td class="num">' + fmt(laborTotal) + '원</td><td></td></tr>';
    html += '<tr><td>야간수당</td><td class="num">' + fmt(nightPay) + '원</td><td></td></tr>';
    html += '<tr><td>기타비용 (유니폼/교육/채용)</td><td class="num">' + fmt(etcCost) + '원</td><td></td></tr>';

    document.getElementById('costDetail').innerHTML = html;
    document.getElementById('totalCost').textContent = fmt(totalCost) + '원';

    state.totalCost = totalCost;
    state.perPerson = perPerson;

    // 시뮬레이션 기본값 자동 설정
    document.getElementById('simBaseCost').textContent = fmtMan(totalCost) + '만원';

    // 시나리오 기본값 제안
    const suggested1 = Math.ceil(totalCost / 10000 * 1.25 / 100) * 100; // 25% 마진
    const suggested2 = Math.ceil(totalCost / 10000 * 1.20 / 100) * 100; // 20% 마진
    const suggested3 = Math.ceil(totalCost / 10000 * 1.15 / 100) * 100; // 15% 마진

    if (!state._manualQuote) {
        document.getElementById('simQuote1').value = suggested1;
        document.getElementById('simQuote2').value = suggested2;
        document.getElementById('simQuote3').value = suggested3;

        // 항목 분배 자동
        document.getElementById('itemDogup').value = Math.round(suggested1 * 0.89 / 100) * 100;
        document.getElementById('itemManage').value = Math.round(suggested1 * 0.067 / 50) * 50;
        document.getElementById('itemAdmin').value = suggested1 - document.getElementById('itemDogup').valueAsNumber - document.getElementById('itemManage').valueAsNumber;
    }
}

// ===== 시뮬레이션 =====
function updateScenarios() {
    state._manualQuote = true;
    const cost = state.totalCost || 0;
    [1,2,3].forEach(i => {
        const quote = (parseInt(document.getElementById('simQuote'+i).value) || 0) * 10000;
        const profit = quote - cost;
        const margin = quote > 0 ? (profit / quote * 100) : 0;

        document.getElementById('simProfit'+i).textContent = fmtMan(profit) + '만원';
        document.getElementById('simMargin'+i).textContent = margin.toFixed(1) + '%';

        // 색상 표시
        const el = document.getElementById('simMargin'+i);
        if (margin < 15) el.style.color = '#e53e3e';
        else if (margin < 20) el.style.color = '#ed8936';
        else el.style.color = '#38a169';
    });
}

function updateItemTotal() {
    const d = parseInt(document.getElementById('itemDogup').value) || 0;
    const m = parseInt(document.getElementById('itemManage').value) || 0;
    const a = parseInt(document.getElementById('itemAdmin').value) || 0;
    const total = d + m + a;
    document.getElementById('itemTotal').textContent = fmt(total) + '만원';

    const quote1 = parseInt(document.getElementById('simQuote1').value) || 0;
    const mismatch = document.getElementById('itemMismatch');
    if (total !== quote1) {
        mismatch.style.display = 'block';
    } else {
        mismatch.style.display = 'none';
    }
}

// ===== 견적서 생성 (유형별 분기) =====
function generateQuote() {
    const type = state.quoteType || 'outsource';
    if (type === 'outsource') return generateQuoteOutsource();
    if (type === 'labor') return generateQuoteLabor();
    if (type === 'cs-agent') return generateQuoteCSAgent();
    if (type === 'cs-share') return generateQuoteCSShare();
    if (type === 'recruit') return generateQuoteRecruit();
    return generateQuoteOutsource(); // fallback
}

// --- 공통 견적서 CSS ---
function getQuoteCSS() {
    return `* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Noto Sans KR',sans-serif; background:#f0f0f0; color:#333; font-size:13px; line-height:1.75; font-weight:400; letter-spacing:-0.02em; }
.document { max-width:210mm; margin:20px auto; background:#fff; box-shadow:0 2px 20px rgba(0,0,0,0.1); }
.header { padding:40px 50px 30px; border-bottom:3px solid #1a365d; }
.header-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:30px; }
.header h1 { font-size:30px; font-weight:600; color:#1a365d; letter-spacing:12px; }
.header-info { text-align:right; font-size:12px; color:#666; line-height:1.8; }
.header-info .label { color:#999; margin-right:8px; }
.total-box { background:#f8fafc; border:2px solid #1a365d; border-radius:8px; padding:20px 30px; display:flex; justify-content:space-between; align-items:center; }
.total-label { font-size:14px; font-weight:500; color:#1a365d; }
.total-amount { font-size:22px; font-weight:600; color:#1a365d; }
.total-sub { font-size:12px; color:#888; margin-top:4px; }
.body { padding:30px 50px 40px; }
.parties { display:flex; gap:40px; margin-bottom:30px; }
.party { flex:1; background:#fafafa; border-radius:6px; padding:18px 22px; }
.party-title { font-size:11px; color:#1a365d; font-weight:600; letter-spacing:1px; margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid #e2e8f0; }
.party-table { width:100%; }
.party-table td { padding:4px 0; font-size:12px; vertical-align:top; }
.party-table td:first-child { color:#888; width:60px; }
.party-table td:last-child { font-weight:500; }
.section { margin-bottom:28px; }
.section-title { font-size:14px; font-weight:600; color:#1a365d; padding-bottom:8px; border-bottom:1px solid #cbd5e0; margin-bottom:15px; }
.section-title .num { display:inline-block; background:#1a365d; color:#fff; width:20px; height:20px; border-radius:50%; text-align:center; line-height:20px; font-size:10px; margin-right:8px; }
table.qt { width:100%; border-collapse:collapse; margin:10px 0; }
table.qt thead th { background:#1a365d; color:#fff; padding:10px 14px; font-size:11px; font-weight:500; text-align:center; }
table.qt thead th:first-child { text-align:left; }
table.qt tbody td { padding:10px 14px; border-bottom:1px solid #e2e8f0; font-size:12px; text-align:center; }
table.qt tbody td:first-child { text-align:left; }
table.qt tfoot td { padding:12px 14px; border-top:2px solid #1a365d; font-size:13px; font-weight:600; }
.highlight { color:#1a365d; font-weight:600; font-size:14px; }
.note-box { background:#f7fafc; border:1px solid #e2e8f0; border-radius:6px; padding:16px 20px; font-size:12px; line-height:1.8; }
.footer { text-align:center; padding:20px; font-size:11px; color:#a0aec0; border-top:1px solid #edf2f7; }
.logo-area { text-align:center; padding:20px 0 10px; }
@page { size:A4; margin:15mm; }
@media print { * { -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; } body { background:#fff; } .document { box-shadow:none; margin:0; } }`;
}

function getQuoteHeader(title, quoteNum, quoteDate, totalLabel, totalAmount) {
    return `<div class="header">
    <div class="header-top">
        <h1>${title}</h1>
        <div class="header-info">
            <p><span class="label">견적번호</span> ${quoteNum}</p>
            <p><span class="label">견적일자</span> ${quoteDate}</p>
            <p><span class="label">유효기간</span> 견적일로부터 30일</p>
        </div>
    </div>
    <div class="total-box">
        <div>
            <div class="total-label">${totalLabel}</div>
            <div class="total-sub">부가가치세 별도</div>
        </div>
        <div style="text-align:right;">
            <div class="total-amount">${totalAmount}</div>
            <div class="total-sub">VAT 별도</div>
        </div>
    </div>
</div>`;
}

function getQuoteParties(client, site, contact) {
    return `<div class="parties">
    <div class="party">
        <div class="party-title">수 신</div>
        <table class="party-table">
            <tr><td>업체명</td><td>${client}</td></tr>
            <tr><td>사업장</td><td>${site}</td></tr>
            ${contact ? '<tr><td>담당자</td><td>'+contact+'</td></tr>' : ''}
        </table>
    </div>
    <div class="party">
        <div class="party-title">발 신</div>
        <table class="party-table">
            <tr><td>업체명</td><td>주식회사 워크위드</td></tr>
            <tr><td>TEL</td><td>1600-9878</td></tr>
            <tr><td>FAX</td><td>043-912-9913</td></tr>
            <tr><td>주소</td><td>충주시 예성로 392, 롯데프라자 4층 401호</td></tr>
            <tr><td>대표</td><td>한 세 은</td></tr>
        </table>
    </div>
</div>`;
}

function showQuotePreview(quoteHTML) {
    const preview = document.getElementById('quotePreview');
    const blob = new Blob([quoteHTML], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    preview.innerHTML = '<div class="preview-frame"><iframe id="quoteFrame" src="' + url + '"></iframe></div>';
    state.quoteHTML = quoteHTML;
    autoSave();
}

// ===== 정액제 도급 견적서 =====
function generateQuoteOutsource() {
    const client = document.getElementById('clientName').value || '(업체명)';
    const site = document.getElementById('siteName').value || '(사업장)';
    const contact = document.getElementById('contactName').value || '';
    const quoteNum = document.getElementById('quoteNumber').value || 'WW-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-01';
    const quoteDate = document.getElementById('quoteDate').value || formatKoreanDate(new Date());

    const dogup = parseInt(document.getElementById('itemDogup').value) || 0;
    const manage = parseInt(document.getElementById('itemManage').value) || 0;
    const admin = parseInt(document.getElementById('itemAdmin').value) || 0;
    const total = dogup + manage + admin;

    // 교대조에서 시간 범위 도출
    const s1s = document.getElementById('s1Start').value || '08:00';
    const s1e = document.getElementById('s1End').value || '23:00';
    const s2e = document.getElementById('s2End').value || '';
    const s3e = document.getElementById('s3End').value || '';
    const openTime = s1s;
    const lastEnd = parseTime(s3e) || parseTime(s2e) || parseTime(s1e) || 23;
    const closeStr = lastEnd >= 24 ? '24:00' : fmtTime(lastEnd);
    const perShift = document.getElementById('perShift').value;

    const workLines = (document.getElementById('workScope').value || '').split('\n').filter(l => l.trim());
    const noteLines = [];
    noteLines.push('위 내용은 예산(안)으로 실제 근무내용 및 근로자 수에 따라 상이할 수 있음.');
    noteLines.push('부가세 별도 청구함.');
    noteLines.push('야간수당(22시 이후) 및 공휴일 가산수당은 도급비에 포함되어 있음.');
    noteLines.push('운영 시간 또는 서비스 범위 변경 시 월 도급비는 협의를 통해 조정함.');
    const userNotes = (document.getElementById('quoteNotes').value || '').split('\n').filter(l => l.trim());
    userNotes.forEach(n => noteLines.push(n));

    const quoteHTML = `<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>견적서 - ${client} ${site} 인력운영 위탁도급</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Noto Sans KR',sans-serif; background:#f0f0f0; color:#333; font-size:13px; line-height:1.75; font-weight:400; letter-spacing:-0.02em; }
        .document { max-width:210mm; margin:20px auto; background:#fff; box-shadow:0 2px 20px rgba(0,0,0,0.1); }
        .header { padding:40px 50px 30px; border-bottom:3px solid #1a365d; }
        .header-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:30px; }
        .header h1 { font-size:30px; font-weight:600; color:#1a365d; letter-spacing:12px; }
        .header-info { text-align:right; font-size:12px; color:#666; line-height:1.8; }
        .header-info .label { color:#999; margin-right:8px; }
        .total-box { background:#f8fafc; border:2px solid #1a365d; border-radius:8px; padding:20px 30px; display:flex; justify-content:space-between; align-items:center; }
        .total-label { font-size:14px; font-weight:500; color:#1a365d; }
        .total-amount { font-size:22px; font-weight:600; color:#1a365d; }
        .total-sub { font-size:12px; color:#888; margin-top:4px; }
        .body { padding:30px 50px 40px; }
        .parties { display:flex; gap:40px; margin-bottom:30px; }
        .party { flex:1; background:#fafafa; border-radius:6px; padding:18px 22px; }
        .party-title { font-size:11px; color:#1a365d; font-weight:600; letter-spacing:1px; margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid #e2e8f0; }
        .party-table { width:100%; }
        .party-table td { padding:4px 0; font-size:12px; vertical-align:top; }
        .party-table td:first-child { color:#888; width:60px; }
        .party-table td:last-child { font-weight:500; }
        .section { margin-bottom:28px; }
        .section-title { font-size:14px; font-weight:600; color:#1a365d; padding-bottom:8px; border-bottom:1px solid #cbd5e0; margin-bottom:15px; }
        .section-title .num { display:inline-block; background:#1a365d; color:#fff; width:20px; height:20px; border-radius:50%; text-align:center; line-height:20px; font-size:10px; margin-right:8px; }
        table.qt { width:100%; border-collapse:collapse; margin:10px 0; }
        table.qt thead th { background:#1a365d; color:#fff; padding:10px 14px; font-size:11px; font-weight:500; text-align:center; }
        table.qt thead th:first-child { text-align:left; }
        table.qt tbody td { padding:10px 14px; border-bottom:1px solid #e2e8f0; font-size:12px; text-align:center; }
        table.qt tbody td:first-child { text-align:left; }
        table.qt tfoot td { padding:12px 14px; border-top:2px solid #1a365d; font-size:13px; font-weight:600; }
        .highlight { color:#1a365d; font-weight:600; font-size:14px; }
        .note-box { background:#f7fafc; border:1px solid #e2e8f0; border-radius:6px; padding:16px 20px; font-size:12px; line-height:1.8; }
        .footer { text-align:center; padding:20px; font-size:11px; color:#a0aec0; border-top:1px solid #edf2f7; }
        @page { size:A4; margin:15mm; }
        @media print { * { -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; } body { background:#fff; } .document { box-shadow:none; margin:0; } }
    </style>
</head>
<body>
<div class="document">
    <div class="header">
        <div class="header-top">
            <h1>견 적 서</h1>
            <div class="header-info">
                <p><span class="label">견적번호</span> ${quoteNum}</p>
                <p><span class="label">견적일자</span> ${quoteDate}</p>
                <p><span class="label">유효기간</span> 견적일로부터 30일</p>
            </div>
        </div>
        <div class="total-box">
            <div>
                <div class="total-label">${site} 운영 위탁 월 도급비</div>
                <div class="total-sub">부가가치세 별도</div>
            </div>
            <div style="text-align:right;">
                <div class="total-amount">월 ${fmt(total * 10000)}원</div>
                <div class="total-sub">금 ${numToKorean(total * 10000)}원정 (VAT 별도)</div>
            </div>
        </div>
    </div>

    <div class="body">
        <div class="parties">
            <div class="party">
                <div class="party-title">수 신</div>
                <table class="party-table">
                    <tr><td>업체명</td><td>${client}</td></tr>
                    <tr><td>사업장</td><td>${site}</td></tr>
                    ${contact ? '<tr><td>담당자</td><td>'+contact+'</td></tr>' : ''}
                </table>
            </div>
            <div class="party">
                <div class="party-title">발 신</div>
                <table class="party-table">
                    <tr><td>업체명</td><td>워크위드</td></tr>
                    <tr><td>대표</td><td>홍 대표</td></tr>
                </table>
            </div>
        </div>

        ${workLines.length > 0 ? `
        <div class="section">
            <div class="section-title"><span class="num">1</span>위탁 개요</div>
            <table class="qt">
                <thead><tr><th style="text-align:left;">항목</th><th style="width:200px;">내용</th></tr></thead>
                <tbody>
                    <tr><td style="text-align:left;">위탁 사업장</td><td>${client} ${site}</td></tr>
                    <tr><td style="text-align:left;">운영 시간</td><td>${openTime} ~ ${closeStr} / ${state.opDays}</td></tr>
                    <tr><td style="text-align:left;">운영 방식</td><td>${state.shifts} 운영</td></tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title"><span class="num">2</span>업무 범위</div>
            <table class="qt">
                <thead><tr><th style="text-align:left;">#</th><th style="text-align:left;">업무 내용</th></tr></thead>
                <tbody>
                    ${workLines.map((l,i) => '<tr><td style="text-align:left;width:40px;">'+(i+1)+'</td><td style="text-align:left;">'+l.trim()+'</td></tr>').join('')}
                </tbody>
            </table>
        </div>
        ` : ''}

        <div class="section">
            <div class="section-title"><span class="num">3</span>견적 금액</div>
            <table class="qt">
                <thead><tr><th style="text-align:left;">항목</th><th style="width:140px;">단위</th><th style="width:160px;">금액</th></tr></thead>
                <tbody>
                    <tr>
                        <td style="text-align:left;"><strong>${site} 운영 위탁 도급비</strong><br><span style="font-size:11px;color:#888;">${openTime}~${closeStr} / ${state.opDays} / ${state.shifts} 전 시간대 커버</span></td>
                        <td>월 정액</td>
                        <td>${fmt(dogup * 10000)}원</td>
                    </tr>
                    <tr>
                        <td style="text-align:left;"><strong>현장관리비</strong><br><span style="font-size:11px;color:#888;">현장관리자 상시 배치, 품질·근태 관리</span></td>
                        <td>월 정액</td>
                        <td>${fmt(manage * 10000)}원</td>
                    </tr>
                    <tr>
                        <td style="text-align:left;"><strong>관리운영비</strong><br><span style="font-size:11px;color:#888;">보험, 유니폼, 교육, 채용·충원 비용</span></td>
                        <td>월 정액</td>
                        <td>${fmt(admin * 10000)}원</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td style="text-align:left;"><strong>합계 (부가세 별도)</strong></td>
                        <td></td>
                        <td class="highlight">${fmt(total * 10000)}원</td>
                    </tr>
                </tfoot>
            </table>

            <div class="note-box" style="margin-top:12px;">
                <p><strong>서비스 보장 기준</strong></p>
                <p>· 영업시간(${openTime}~${closeStr}) 전 시간대 운영인력 배치 보장</p>
                <p>· 교대당 최소 <strong>${perShift}명 이상</strong> 현장 배치</p>
                ${state.manager === '1명 배치' ? '<p>· 현장관리자 <strong>상시 1명</strong> 배치</p>' : ''}
                <p>· 결원 발생 시 <strong>당일 충원</strong></p>
                <p style="margin-top:6px;color:#888;font-size:11px;">※ 인력 배치 규모는 당사가 서비스 품질 기준에 따라 자체 결정합니다.</p>
            </div>
        </div>

        ${getServiceDescription('outsource')}
        ${getIndustryPackage()}

        <div class="section">
            <div class="section-title"><span class="num">4</span>특기사항</div>
            <div class="note-box">
                ${noteLines.map((l,i) => '<p>'+(i+1)+'. '+l.trim()+'</p>').join('')}
            </div>
        </div>
    </div>

    <div class="footer">워크위드 | 본 견적서는 견적일로부터 30일간 유효합니다.</div>
</div>
</body>
</html>`;

    showQuotePreview(quoteHTML);
}

// ===== 일반 도급 견적서 (인건비 기반 1인 단가) =====
function generateQuoteLabor() {
    const client = document.getElementById('clientName').value || '(업체명)';
    const site = document.getElementById('siteName').value || '';
    const contact = document.getElementById('contactName').value || '';
    const quoteNum = document.getElementById('quoteNumber').value || 'WW-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-001';
    const quoteDate = document.getElementById('quoteDate').value || formatKoreanDate(new Date());

    const wage = parseInt(document.getElementById('hourlyWage').value) || 10500;
    const baseWage = wage * 209;
    const rPension = (parseFloat(document.getElementById('ratePension').value) || 4.5) / 100;
    const rHealth = (parseFloat(document.getElementById('rateHealth').value) || 3.545) / 100;
    const rEmploy = (parseFloat(document.getElementById('rateEmploy').value) || 0.9) / 100;
    const rIndust = (parseFloat(document.getElementById('rateIndust').value) || 1.5) / 100;
    const rRetire = (parseFloat(document.getElementById('rateRetire').value) || 8.33) / 100;
    const longCare = (parseFloat(document.getElementById('laborLongCare')?.value) || 13.14) / 100;
    const bizTax = (parseFloat(document.getElementById('laborBizTax')?.value) || 0.5) / 100;
    const transport = parseInt(document.getElementById('laborTransport')?.value) || 100000;
    const leaderPay = parseInt(document.getElementById('laborLeaderPay')?.value) || 100000;
    const mgmtPct = parseFloat(document.getElementById('laborMgmtFee')?.value) || 8;

    // 계산
    const pension = Math.round(baseWage * rPension);
    const health = Math.round(baseWage * rHealth);
    const longCareAmt = Math.round(health * longCare);
    const employ = Math.round(baseWage * rEmploy);
    const indust = Math.round(baseWage * rIndust);
    const bizTaxAmt = Math.round(baseWage * bizTax);
    const retire = Math.round(baseWage * rRetire); // 발생시 청구
    const annualLeave = Math.round(wage * 8); // 연차수당 = 통상시급×8h

    const laborSub1 = baseWage + transport;
    const laborSub2 = annualLeave;
    const laborTotal = laborSub1 + laborSub2;
    const insuranceTotal = pension + health + longCareAmt + employ + indust + bizTaxAmt;
    const subtotal = laborTotal + insuranceTotal;
    const mgmtAmt = Math.round(subtotal * mgmtPct / 100);
    const perPersonTotal = subtotal + mgmtAmt;

    // 시간 정보
    const s1s = document.getElementById('s1Start').value || '09:00';
    const s1e = document.getElementById('s1End').value || '18:00';

    const workLines = (document.getElementById('workScope').value || '').split('\n').filter(l => l.trim());
    const noteLines = [];
    noteLines.push('위 내용은 예산(안)으로 실제 근무내용 및 근로자 수에 따라 상이할 수 있음.');
    noteLines.push('최저시급 및 4대보험은 당해연도 법정 기준을 반영함.');
    noteLines.push('근로기준법에 의거한 연장, 심야, 휴일근무 수당 및 퇴직금 등은 발생 시 별도 청구함.');
    noteLines.push('관리수수료 포함내역: 채용 광고비, 급여/4대보험 행정대행, 노무 자문 및 리스크 관리, 결원 대응비, 근로자 복리후생비 등 제세 간접비 포함');
    noteLines.push('부가세 별도 청구함.');
    const userNotes1 = (document.getElementById('quoteNotes').value || '').split('\n').filter(l => l.trim());
    userNotes1.forEach(n => noteLines.push(n));

    const quoteHTML = `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>도급견적서 - ${client}</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>${getQuoteCSS()}</style></head><body>
<div class="document">
${getQuoteHeader('도 급 견 적 서', quoteNum, quoteDate, client + ' 도급 운영 위탁', '1인 단가 ' + fmt(perPersonTotal) + '원')}
<div class="body">
${getQuoteParties(client, site || '-', contact)}

<div class="section">
    <div class="section-title"><span class="num">1</span>견적 내용</div>
    <table class="qt">
        <thead><tr><th style="text-align:left;">항목</th><th>내용</th></tr></thead>
        <tbody>
            <tr><td style="text-align:left;">내용</td><td>${client} ${workLines.length > 0 ? workLines[0] : '도급 운영 위탁'}</td></tr>
            <tr><td style="text-align:left;">운영시간</td><td>${s1s}~${s1e}</td></tr>
            <tr><td style="text-align:left;">운영장소</td><td>${site || '-'}</td></tr>
            <tr><td style="text-align:left;">인력 근무조건</td><td>일 8시간 근무 기준 (${state.opDays})</td></tr>
            ${workLines.length > 0 ? '<tr><td style="text-align:left;">업무범위</td><td>' + workLines.join(', ') + '</td></tr>' : ''}
        </tbody>
    </table>
</div>

<div class="section">
    <div class="section-title"><span class="num">2</span>운영 예산안 <span style="font-size:11px;font-weight:400;color:#888;">(적용시급: ${fmt(wage)}원) (단위: 원)</span></div>
    <table class="qt">
        <thead><tr><th style="text-align:left;">계정과목</th><th style="text-align:left;">세부내용</th><th>산출내역</th><th style="text-align:right;">합계</th></tr></thead>
        <tbody>
            <tr><td style="text-align:left;" rowspan="4"><strong>직접노무비</strong><br>(급여)</td>
                <td style="text-align:left;">기본급</td><td>적용시급×209시간</td><td style="text-align:right;">${fmt(baseWage)}</td></tr>
            <tr><td style="text-align:left;">교통비</td><td></td><td style="text-align:right;">${fmt(transport)}</td></tr>
            <tr><td style="text-align:left;">직책수당</td><td>현장관리자 한정</td><td style="text-align:right;color:#888;">별도</td></tr>
            <tr><td style="text-align:left;"><strong>① 소계</strong></td><td></td><td style="text-align:right;font-weight:600;">${fmt(laborSub1)}</td></tr>

            <tr><td style="text-align:left;" rowspan="3"></td>
                <td style="text-align:left;">퇴직금</td><td></td><td style="text-align:right;color:#888;">발생시 청구</td></tr>
            <tr><td style="text-align:left;">연차수당</td><td>통상시급×8시간</td><td style="text-align:right;">${fmt(annualLeave)}</td></tr>
            <tr><td style="text-align:left;"><strong>② 소계</strong></td><td></td><td style="text-align:right;font-weight:600;">${fmt(laborSub2)}</td></tr>

            <tr style="background:#f0f5ff;"><td style="text-align:left;" colspan="2"><strong>③ 합계 (①+②)</strong></td><td></td><td style="text-align:right;font-weight:700;">${fmt(laborTotal)}</td></tr>

            <tr><td style="text-align:left;" rowspan="7"><strong>간접노무비</strong><br>(4대보험)</td>
                <td style="text-align:left;">국민연금</td><td>임금 합계×${(rPension*100).toFixed(2)}%</td><td style="text-align:right;">${fmt(pension)}</td></tr>
            <tr><td style="text-align:left;">건강보험</td><td>임금 합계×${(rHealth*100).toFixed(3)}%</td><td style="text-align:right;">${fmt(health)}</td></tr>
            <tr><td style="text-align:left;">장기요양보험</td><td>건강보험료×${(longCare*100).toFixed(2)}%</td><td style="text-align:right;">${fmt(longCareAmt)}</td></tr>
            <tr><td style="text-align:left;">고용보험</td><td>임금 합계×${(rEmploy*100).toFixed(2)}%</td><td style="text-align:right;">${fmt(employ)}</td></tr>
            <tr><td style="text-align:left;">산재보험</td><td>임금 합계×${(rIndust*100).toFixed(3)}%</td><td style="text-align:right;">${fmt(indust)}</td></tr>
            <tr><td style="text-align:left;">사업소세</td><td>임금 합계×${(bizTax*100).toFixed(1)}%</td><td style="text-align:right;">${fmt(bizTaxAmt)}</td></tr>
            <tr><td style="text-align:left;"><strong>④ 소계</strong></td><td></td><td style="text-align:right;font-weight:600;">${fmt(insuranceTotal)}</td></tr>

            <tr style="background:#f0f5ff;"><td style="text-align:left;" colspan="2"><strong>⑤ 합계 (③+④)</strong></td><td></td><td style="text-align:right;font-weight:700;">${fmt(subtotal)}</td></tr>

            <tr><td style="text-align:left;"><strong>수수료</strong></td>
                <td style="text-align:left;">관리 수수료</td><td>${mgmtPct}%</td><td style="text-align:right;">${fmt(mgmtAmt)}</td></tr>
        </tbody>
        <tfoot>
            <tr><td style="text-align:left;" colspan="2"><strong>총계 (⑤+수수료) — 1인기준 (VAT 별도)</strong></td><td></td><td style="text-align:right;" class="highlight">${fmt(perPersonTotal)}</td></tr>
            <tr><td style="text-align:left;" colspan="2">월 청구 예상액</td><td></td><td style="text-align:right;color:#888;">실 투입 인원 × 1인 단가 적용</td></tr>
        </tfoot>
    </table>
</div>

${getServiceDescription('labor')}
${getIndustryPackage()}

<div class="section">
    <div class="section-title"><span class="num">3</span>기타사항</div>
    <div class="note-box">
        ${noteLines.map((l,i) => '<p>'+(i+1)+'. '+l.trim()+'</p>').join('')}
    </div>
</div>
</div>
<div class="footer">워크위드 | 본 견적서는 견적일로부터 30일간 유효합니다.</div>
</div></body></html>`;

    showQuotePreview(quoteHTML);
}

// ===== CS대행 견적서 (위드콜) =====
function generateQuoteCSAgent() {
    const client = document.getElementById('clientName').value || '(업체명)';
    const site = document.getElementById('siteName').value || '';
    const contact = document.getElementById('contactName').value || '';
    const quoteNum = document.getElementById('quoteNumber').value || 'WWC-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-001';
    const quoteDate = document.getElementById('quoteDate').value || formatKoreanDate(new Date());

    const seniorN = parseInt(document.getElementById('csSeniorCount').value) || 0;
    const seniorS = parseInt(document.getElementById('csSeniorSalary').value) || 0;
    const juniorN = parseInt(document.getElementById('csJuniorCount').value) || 0;
    const juniorS = parseInt(document.getElementById('csJuniorSalary').value) || 0;
    const asp = parseInt(document.getElementById('csASP').value) || 0;
    const mgmtPct = parseFloat(document.getElementById('csMgmtFee').value) || 8;
    const setupFee = parseInt(document.getElementById('csSetupFee').value) || 0;
    const opTime = document.getElementById('csOpTime').value || '';
    const workCond = document.getElementById('csWorkCond').value || '';
    const workScope = document.getElementById('csWorkScope').value || '';

    const totalPeople = seniorN + juniorN;
    const laborCost = seniorN * seniorS + juniorN * juniorS;
    const aspCost = asp * totalPeople;
    const subtotal = laborCost + aspCost;
    const mgmtCost = Math.round(subtotal * mgmtPct / 100);
    const calcTotal = subtotal + mgmtCost;
    const finalPrice = parseInt(document.getElementById('csAgentFinalPrice').value) || calcTotal;

    const noteLines = [];
    noteLines.push('위 내용은 예산(안)으로 실제 근무내용 및 근로자 수에 따라 상이할 수 있음.');
    noteLines.push('최저시급 및 4대보험은 연도별 기준을 반영함.');
    noteLines.push('교육비 별도 청구.');
    noteLines.push('야간, 휴일, 연장 근무 발생 시 별도 수당 청구.');
    noteLines.push('초기 구축비 ' + fmt(setupFee) + '원 별도 청구.' + (setupFee === 0 ? ' → 한시적 면제 프로모션 적용' : ''));
    noteLines.push('부가세 별도 청구함.');
    const userNotes2 = (document.getElementById('quoteNotes').value || '').split('\n').filter(l => l.trim());
    userNotes2.forEach(n => noteLines.push(n));

    let peopleRows = '';
    if (seniorN > 0) peopleRows += `<tr><td style="text-align:left;" rowspan="${juniorN > 0 ? 1 : 1}"><strong>직·간접<br>노무비</strong></td><td style="text-align:left;">선임 상담사</td><td>${fmt(seniorS)}</td><td>${seniorN}</td><td style="text-align:right;">${fmt(seniorN*seniorS)}</td></tr>`;
    if (juniorN > 0) peopleRows += `<tr>${seniorN === 0 ? '<td style="text-align:left;"><strong>직·간접<br>노무비</strong></td>' : ''}<td style="text-align:left;">일반 상담사</td><td>${fmt(juniorS)}</td><td>${juniorN}</td><td style="text-align:right;">${fmt(juniorN*juniorS)}</td></tr>`;

    const quoteHTML = `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>위드콜 견적서 - ${client}</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>${getQuoteCSS()}</style></head><body>
<div class="document">
${getQuoteHeader('위드콜 견적서', quoteNum, quoteDate, 'CS대행 서비스', '최종 제안가 ' + fmt(finalPrice) + '원')}
<div class="body">
${getQuoteParties(client, site || '-', contact)}

<div class="section">
    <div class="section-title"><span class="num">1</span>견적 내용</div>
    <table class="qt">
        <thead><tr><th style="text-align:left;">항목</th><th>내용</th></tr></thead>
        <tbody>
            <tr><td style="text-align:left;">내용</td><td>${workScope || client + ' CS 업무'}</td></tr>
            <tr><td style="text-align:left;">운영시간</td><td>${opTime}</td></tr>
            <tr><td style="text-align:left;">인력 근무조건</td><td>${workCond}</td></tr>
            <tr><td style="text-align:left;">업무범위</td><td>${workScope}</td></tr>
        </tbody>
    </table>
</div>

<div class="section">
    <div class="section-title"><span class="num">2</span>운영 예산안 <span style="font-size:11px;font-weight:400;color:#888;">(단위: 원)</span></div>
    <table class="qt">
        <thead><tr><th style="text-align:left;">계정과목</th><th style="text-align:left;">항목</th><th>단가</th><th>인원</th><th style="text-align:right;">합계</th></tr></thead>
        <tbody>
            ${peopleRows}
            <tr style="background:#f7fafc;"><td style="text-align:left;" colspan="3"><strong>① 소계</strong></td><td>${totalPeople}</td><td style="text-align:right;font-weight:600;">${fmt(laborCost)}</td></tr>
            <tr><td style="text-align:left;" rowspan="3"><strong>운영비</strong></td><td style="text-align:left;">ASP 패키지</td><td>${fmt(asp)}</td><td>${totalPeople}</td><td style="text-align:right;">${fmt(aspCost)}</td></tr>
            <tr><td style="text-align:left;">원 운영비</td><td colspan="2" style="text-align:center;color:#888;">발신비용 실비 청구</td><td style="text-align:right;">-</td></tr>
            <tr><td style="text-align:left;"><strong>② 소계</strong></td><td></td><td></td><td style="text-align:right;font-weight:600;">${fmt(aspCost)}</td></tr>
            <tr style="background:#f7fafc;"><td style="text-align:left;" colspan="3"><strong>③ 합계 (①+②)</strong></td><td></td><td style="text-align:right;font-weight:700;">${fmt(subtotal)}</td></tr>
            <tr><td style="text-align:left;"><strong>수수료</strong></td><td style="text-align:left;">관리 수수료</td><td>${mgmtPct}%</td><td></td><td style="text-align:right;">${fmt(mgmtCost)}</td></tr>
        </tbody>
        <tfoot>
            <tr><td style="text-align:left;" colspan="3"><strong>⑤ 총계 (③+④)</strong></td><td></td><td style="text-align:right;" class="highlight">${fmt(calcTotal)}</td></tr>
            ${finalPrice !== calcTotal ? '<tr><td style="text-align:left;" colspan="3"><strong style="color:#e53e3e;">최종 제안가</strong></td><td></td><td style="text-align:right;font-size:16px;font-weight:700;color:#e53e3e;">' + fmt(finalPrice) + '</td></tr>' : ''}
        </tfoot>
    </table>
</div>

${getServiceDescription('cs-agent')}
${getIndustryPackage()}

<div class="section">
    <div class="section-title"><span class="num">3</span>기타사항</div>
    <div class="note-box">
        ${noteLines.map((l,i) => '<p>'+(i+1)+'. '+l.trim()+'</p>').join('')}
    </div>
</div>
</div>
<div class="footer">워크위드 | 본 견적서는 견적일로부터 30일간 유효합니다.</div>
</div></body></html>`;

    showQuotePreview(quoteHTML);
}

// ===== CS쉐어링 견적서 =====
function generateQuoteCSShare() {
    const client = document.getElementById('clientName').value || '(업체명)';
    const site = document.getElementById('siteName').value || '';
    const contact = document.getElementById('contactName').value || '';
    const quoteNum = document.getElementById('quoteNumber').value || 'WWC-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-001';
    const quoteDate = document.getElementById('quoteDate').value || formatKoreanDate(new Date());

    const baseFee = parseInt(document.getElementById('shareBaseFee').value) || 0;
    const baseCall = parseInt(document.getElementById('shareBaseCall').value) || 0;
    const perCall = parseInt(document.getElementById('sharePerCall').value) || 0;
    const comm = document.getElementById('shareComm').value;
    const opTime = document.getElementById('shareOpTime').value || '';
    const setupFee = parseInt(document.getElementById('shareSetupFee').value) || 0;
    const workScope = document.getElementById('shareWorkScope').value || '';
    const services = document.getElementById('shareServices').value || '';
    const callStandard = document.getElementById('shareCallStandard').value || '월 ' + baseCall + '건 기준';
    const finalPrice = parseInt(document.getElementById('csShareFinalPrice').value) || baseFee;

    const noteLines = [];
    noteLines.push('위 내용은 예산(안)으로 실제 근무 내용과 발생 건수에 따라 조정될 수 있음.');
    noteLines.push('녹취 및 시스템 이용료 포함 및 DB 제공. 녹취서비스는 60일 보관기준이며 DB 제공은 주간, 월간 보고서 형태로 제출.');
    noteLines.push('근무요일 및 시간: ' + opTime);
    noteLines.push('발신 비용은 별도로 실비 청구함(아웃콜).');
    if (setupFee > 0) noteLines.push('초기 구축 비용 ' + fmt(setupFee) + '원 별도 청구 (1회성).');
    noteLines.push('최소 12개월 이상 계약 체결 필수.');
    noteLines.push('부가세 별도 청구함.');
    noteLines.push('주말(공휴일), 야간, 심야 시간대 단가 협의 필요.');
    const userNotes3 = (document.getElementById('quoteNotes').value || '').split('\n').filter(l => l.trim());
    userNotes3.forEach(n => noteLines.push(n));

    const quoteHTML = `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>CS쉐어링 견적서 - ${client}</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>${getQuoteCSS()}</style></head><body>
<div class="document">
${getQuoteHeader('견 적 서', quoteNum, quoteDate, 'CS쉐어링 서비스 (' + callStandard + ')', '최종 제안가 월 ' + fmt(finalPrice) + '원')}
<div class="body">
${getQuoteParties(client, site || '-', contact)}

<div class="section">
    <div class="section-title"><span class="num">1</span>견적 내용</div>
    <table class="qt">
        <thead><tr><th style="text-align:left;">항목</th><th>내용</th></tr></thead>
        <tbody>
            <tr><td style="text-align:left;">내용</td><td>${workScope || client + ' CS 쉐어링'}</td></tr>
            <tr><td style="text-align:left;">운영시간</td><td>${opTime}</td></tr>
            <tr><td style="text-align:left;">운영 조건</td><td>CS 쉐어 ${callStandard}</td></tr>
            <tr><td style="text-align:left;">업무범위</td><td>${workScope}</td></tr>
        </tbody>
    </table>
</div>

<div class="section">
    <div class="section-title"><span class="num">2</span>운영 예산안 <span style="font-size:11px;font-weight:400;color:#888;">(단위: 원)</span></div>
    <table class="qt">
        <thead><tr><th style="text-align:left;">내용</th><th>1건 당<br>(${callStandard})</th><th style="text-align:right;">금액</th><th>비고</th></tr></thead>
        <tbody>
            <tr><td style="text-align:left;">기본료</td><td></td><td style="text-align:right;">${fmt(baseFee)}</td><td>${callStandard} 기본료</td></tr>
            <tr><td style="text-align:left;">콜 단가</td><td>${fmt(perCall)}원/건</td><td style="text-align:right;">-</td><td>월 ${baseCall}건 초과 건당<br>${opTime} 근무 기준</td></tr>
            <tr><td style="text-align:left;">통신 비용 (실비 청구)</td><td></td><td style="text-align:right;">-</td><td>${comm === '실비청구' ? '아웃콜 등 실비 발생 시 청구' : '기본료 포함'}</td></tr>
        </tbody>
        <tfoot>
            <tr><td style="text-align:left;"><strong>합계</strong></td><td></td><td style="text-align:right;" class="highlight">${fmt(baseFee)}원~</td><td>VAT 별도</td></tr>
            <tr><td style="text-align:left;"><strong style="color:#e53e3e;">최종 제안가</strong></td><td></td><td style="text-align:right;font-size:16px;font-weight:700;color:#e53e3e;">${fmt(finalPrice)}</td><td>VAT 별도</td></tr>
        </tfoot>
    </table>
</div>

${getServiceDescription('cs-share')}
${getIndustryPackage()}

<div class="section">
    <div class="section-title"><span class="num">3</span>기타사항</div>
    <div class="note-box">
        ${noteLines.map((l,i) => '<p>'+(i+1)+'. '+l.trim()+'</p>').join('')}
    </div>
</div>
</div>
<div class="footer">워크위드 | 본 견적서는 견적일로부터 30일간 유효합니다.</div>
</div></body></html>`;

    showQuotePreview(quoteHTML);
}

// ===== 유형별 제공 서비스 설명 HTML =====
function getServiceDescription(type) {
    const services = {
        outsource: {
            title: '워크위드 위탁도급 서비스 안내',
            items: [
                { name: '자체 인력 채용·배치', desc: '당사 자체 채용 프로세스를 통한 적합 인력 선발 및 배치' },
                { name: '현장관리자 상시 배치', desc: '품질·근태·안전 관리를 위한 전담 관리자 상주' },
                { name: '교육·훈련 운영', desc: '신입 교육, 서비스 교육, 정기 직무 교육 자체 실시' },
                { name: '결원 즉시 충원', desc: '퇴사·결근 발생 시 당일 대체인력 투입 보장' },
                { name: '4대보험·급여 관리', desc: '근로자 4대보험 가입, 급여 지급, 노무관리 일체 처리' },
                { name: '적법 도급 운영', desc: '독립적 지휘체계·공정분리로 불법파견 리스크 원천 차단' }
            ]
        },
        labor: {
            title: '워크위드 인력 도급 서비스 안내',
            items: [
                { name: '전문 인력 선발', desc: '직무 적합성 평가를 거친 경험 인력 우선 배치' },
                { name: '현장관리자 상시 배치', desc: '품질·근태·안전 관리를 위한 전담 관리자 상주' },
                { name: '4대보험 완비', desc: '국민연금, 건강보험, 고용보험, 산재보험 전원 가입' },
                { name: '결원 즉시 충원', desc: '퇴사·결근 시 당일 대체인력 투입 보장' },
                { name: '자체 교육 체계', desc: '안전교육, 직무교육, 서비스 교육 정기 실시' },
                { name: '적법 도급 운영', desc: '대법원 판례 기준 7대 요소 충족, 8년 무사고 운영' }
            ]
        },
        'cs-agent': {
            title: '위드콜 CS대행 서비스 안내',
            items: [
                { name: '전문 상담사 배치', desc: '서비스 교육 이수 전문 상담사 전담 배치' },
                { name: 'ASP 시스템 제공', desc: 'CTI, 녹취, 통계 등 콜센터 인프라 일체 포함' },
                { name: 'AI 답변 시스템', desc: 'AI 기반 매뉴얼 검색으로 빠르고 정확한 상담 지원' },
                { name: '품질 관리 (QA)', desc: '통화품질 모니터링, 정기 평가, 개선 피드백' },
                { name: '실시간 리포트', desc: '일간/주간/월간 상담 통계 및 VOC 리포트 제공' },
                { name: '유연한 운영', desc: '운영시간·인원 변경 시 협의를 통한 탄력적 대응' }
            ]
        },
        'cs-share': {
            title: '위드콜 CS쉐어링 서비스 안내',
            items: [
                { name: '전문 상담 인프라', desc: '숙련 상담사가 복수 업체를 효율적으로 공유 대응' },
                { name: 'AI 답변 지원', desc: '업체별 매뉴얼 기반 AI 답변 시스템으로 품질 유지' },
                { name: '녹취·DB 제공', desc: '60일 녹취 보관, 주간/월간 상담 리포트 제공' },
                { name: '초과콜 유연 대응', desc: '기본 콜수 초과 시 건당 과금으로 비용 효율적 운영' },
                { name: '소규모 최적화', desc: '전담 상담사 대비 70% 이상 비용 절감 가능' },
                { name: '빠른 시작', desc: '계약 후 1주 이내 운영 시작, 초기 구축 지원' }
            ]
        },
        recruit: {
            title: '워크위드 채용대행 서비스 안내',
            items: [
                { name: '직무분석·공고 작성', desc: '채용 요건 분석 및 맞춤형 채용공고 작성·게시' },
                { name: '이력서 스크리닝', desc: '적합 지원자 1차 서류 심사 및 추천 리스트 제공' },
                { name: '면접 일정 조율', desc: '지원자·담당자 간 면접 스케줄 조율 대행' },
                { name: '수수료 청구 기간', desc: '채용 확정 후 최소 계약기간 동안 월 수수료 청구' },
                { name: '인력풀 보유', desc: '자체 인력 DB 활용으로 빠른 후보자 매칭' },
                { name: '도급 전환 지원', desc: '채용대행 → 인력 도급 전환 시 원스톱 지원 가능' }
            ]
        }
    };

    const svc = services[type];
    if (!svc) return '';

    return `
<div class="section">
    <div class="section-title"><span class="num">&#9733;</span>${svc.title}</div>
    <table class="qt">
        <thead><tr><th style="text-align:left;width:180px;">서비스 항목</th><th style="text-align:left;">내용</th></tr></thead>
        <tbody>
            ${svc.items.map(item => '<tr><td style="text-align:left;font-weight:600;">' + item.name + '</td><td style="text-align:left;">' + item.desc + '</td></tr>').join('')}
        </tbody>
    </table>
    <div class="note-box" style="margin-top:8px;">
        <p style="font-size:11px;color:#888;">주식회사 워크위드 | 근로자파견사업 허가업체 | 8년 무사고 운영 | TEL 1600-9878</p>
    </div>
</div>`;
}

// ===== 업종별 문제-해결책 패키징 HTML =====
function getIndustryPackage() {
    const industry = document.getElementById('industry').value;
    if (!industry) return '';

    // 하위 호환: 사무/CS → 사무/행정
    const key = industry === '사무/CS' ? '사무/행정' : industry;

    const packages = {
        '세차/주차': {
            title: '세차/주차 업종 맞춤 솔루션',
            items: [
                { pain: '잦은 퇴사로 인력 공백 발생', solution: '자체 인력풀 보유, 당일 대체인력 투입 보장' },
                { pain: '서비스 품질 편차가 큼', solution: '입사 전 서비스 마인드 교육 + 정기 CS교육 실시' },
                { pain: '직접 고용 시 4대보험·노무 부담', solution: '당사가 4대보험·급여·노무관리 일체 처리' },
                { pain: '성수기/비수기 인원 조절 어려움', solution: '탄력배치 운영으로 비수기 비용 절감' }
            ]
        },
        '물류/택배': {
            title: '물류/택배 업종 맞춤 솔루션',
            items: [
                { pain: '야간·새벽 근무자 확보 어려움', solution: '야간 전문 인력 보유, 수당 포함 단가 제시' },
                { pain: '물량 변동에 따른 인력 유동성 필요', solution: '일·주 단위 증감 가능한 탄력 운영 체계' },
                { pain: '산재사고 리스크 높음', solution: '안전교육 의무 실시 + 산재보험 완비' },
                { pain: '인력 관리에 시간·비용 과다 소모', solution: '현장관리자 상주 배치, 근태·품질 일괄 관리' }
            ]
        },
        '제조라인': {
            title: '제조 라인 업종 맞춤 솔루션',
            items: [
                { pain: '불법파견 판정 리스크', solution: '독립 지휘체계·공정분리로 적법도급 운영 (8년 무사고)' },
                { pain: '생산라인 중단 시 매출 손실', solution: '결원 발생 당일 대체인력 투입, 라인 중단 최소화' },
                { pain: '신규 인력 숙련도 낮음', solution: '자체 직무교육 프로그램으로 투입 전 사전 교육' },
                { pain: '근로감독 대응 어려움', solution: '적법운영안내서 제공 + 근로감독 공동 대응' }
            ]
        },
        '사무/행정': {
            title: '사무/행정 업종 맞춤 솔루션',
            items: [
                { pain: '채용 후 조기 퇴사 반복', solution: '적합성 검증 후 배치 + 조기퇴사 시 즉시 교체' },
                { pain: '전문 인력 채용 비용 부담', solution: '도급 전환으로 채용·교육·관리 비용 일괄 절감' },
                { pain: '업무 표준화·인수인계 어려움', solution: '매뉴얼 기반 업무 정립 + 체계적 인수인계 지원' },
                { pain: '단기 프로젝트 인력 필요', solution: '기간 맞춤 인력 배치, 계약기간 자유 설정' }
            ]
        },
        'CS/콜센터': {
            title: 'CS/콜센터 업종 맞춤 솔루션',
            items: [
                { pain: '자체 콜센터 운영비 과다 (CTI·녹취 등)', solution: 'ASP 시스템 일체 포함, 별도 인프라 비용 없음' },
                { pain: '상담 품질 관리가 안 됨', solution: 'QA 전담 + AI 답변 시스템으로 정확도 향상' },
                { pain: '상담원 채용·교육 부담', solution: '전문 상담사 직접 채용·교육 후 배치' },
                { pain: '상담 데이터 활용 못함', solution: '일간/주간 VOC 리포트 + 녹취 DB 제공' }
            ]
        },
        '이커머스': {
            title: '이커머스 업종 맞춤 솔루션',
            items: [
                { pain: '고객 문의·반품·교환 응대에 시간 소모', solution: '전문 상담사가 CS 전반 대행 처리' },
                { pain: 'CS 매뉴얼이 없어 응대 품질 들쭉날쭉', solution: '업체별 맞춤 매뉴얼 구축 + AI 답변 시스템 연동' },
                { pain: 'CS 때문에 마케팅·상품에 집중 못함', solution: 'CS 통합 대행으로 핵심 업무 집중 환경 제공' },
                { pain: '1인·소규모 셀러는 전담 상담사 부담', solution: '쉐어링 방식으로 소규모도 전문 CS 이용 가능' }
            ]
        },
        '경비/시설': {
            title: '경비/시설관리 업종 맞춤 솔루션',
            items: [
                { pain: '24시간 교대근무 인력 확보 난항', solution: '격일근무·3교대 전문 인력 보유' },
                { pain: '고령 인력 관리 어려움', solution: '체력·적합성 평가 후 배치 + 정기 건강관리' },
                { pain: '야간 근무 중 사고 리스크', solution: '안전교육 정기 실시 + 산재보험 완비' },
                { pain: '경비 인력 서비스 마인드 부족', solution: '입주민 응대 교육 + 서비스 마인드 정기 교육' }
            ]
        },
        '호텔/숙박': {
            title: '호텔/숙박 업종 맞춤 솔루션',
            items: [
                { pain: '서비스 품질이 곧 매출에 직결', solution: '호텔 서비스 전문교육 이수 인력 배치' },
                { pain: '객실 청소·프론트 인력 잦은 이탈', solution: '자체 인력풀 활용 당일 충원 보장' },
                { pain: '성수기/비수기 인력 수급 불균형', solution: '시즌별 탄력배치 + 비수기 비용 최적화' },
                { pain: '외국어 가능 인력 부족', solution: '외국어 가능 인력 우선 매칭 서비스' }
            ]
        },
        '식품제조': {
            title: '식품 제조 업종 맞춤 솔루션',
            items: [
                { pain: '위생관리 기준 미충족 시 영업정지', solution: '위생교육 의무화 + HACCP 기준 준수 관리' },
                { pain: '생산량 변동에 따른 인력 유동성 필요', solution: '일·주 단위 인원 증감 가능 탄력 운영' },
                { pain: '불법파견 판정 리스크', solution: '독립 공정분리 + 적법운영안내서 제출' },
                { pain: '제조 경험 인력 확보 어려움', solution: '식품제조 경험자 인력풀 보유 + 사전 교육' }
            ]
        },
        '기타': {
            title: '워크위드 맞춤 솔루션',
            items: [
                { pain: '인력 채용·관리에 시간 소모', solution: '채용부터 관리까지 원스톱 아웃소싱' },
                { pain: '인건비 외 부수 비용(4대보험 등) 부담', solution: '복리후생비·4대보험 포함 단가, 추가비용 없음' },
                { pain: '갑작스러운 결원 대응 어려움', solution: '자체 인력풀 활용 당일 대체 투입 보장' },
                { pain: '노무 리스크(근로감독 등) 부담', solution: '적법 운영 + 노무사 자문 지원' }
            ]
        }
    };

    const pkg = packages[key];
    if (!pkg) return '';

    return `
<div class="section">
    <div class="section-title"><span class="num">&#9733;</span>${pkg.title}</div>
    <table class="qt">
        <thead><tr><th style="text-align:left;width:220px;">업종 고민</th><th style="text-align:left;">워크위드 솔루션</th></tr></thead>
        <tbody>
            ${pkg.items.map(item => '<tr><td style="text-align:left;color:#c53030;">' + item.pain + '</td><td style="text-align:left;font-weight:600;">' + item.solution + '</td></tr>').join('')}
        </tbody>
    </table>
</div>`;
}

// ===== 채용대행 견적서 =====
function generateQuoteRecruit() {
    const client = document.getElementById('clientName').value || '(업체명)';
    const site = document.getElementById('siteName').value || '';
    const contact = document.getElementById('contactName').value || '';
    const quoteNum = document.getElementById('quoteNumber').value || 'WW-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-001';
    const quoteDate = document.getElementById('quoteDate').value || formatKoreanDate(new Date());

    const opTime = document.getElementById('recruitOpTime').value || '';
    const workCond = document.getElementById('recruitWorkCond').value || '';
    const workScope = document.getElementById('recruitWorkScope').value || '';
    const feeRate = parseFloat(document.getElementById('recruitFeeRate').value) || 8;
    const minMonth = parseInt(document.getElementById('recruitMinMonth').value) || 3;
    const finalPrice = parseInt(document.getElementById('recruitFinalPrice').value) || 0;

    // 직무 행 수집
    const rows = document.getElementById('recruitRows').querySelectorAll('tr');
    let peopleRows = '';
    let totalPeople = 0;
    let totalLabor = 0;
    let rowIdx = 0;

    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const selects = row.querySelectorAll('select');
        if (inputs.length < 3) return;
        const jobName = inputs[0].value || '(직무)';
        const career = selects.length > 0 ? selects[0].value : '신입';
        const salary = parseInt(inputs[1].value) || 0;
        const count = parseInt(inputs[2].value) || 0;
        const subtotal = salary * count;
        totalPeople += count;
        totalLabor += subtotal;

        const rowspanAttr = rowIdx === 0 ? ' rowspan="' + rows.length + '"' : '';
        const labelCell = rowIdx === 0 ? '<td style="text-align:left;"' + rowspanAttr + '><strong>인건비</strong></td>' : '';

        peopleRows += `<tr>${labelCell}<td style="text-align:left;">${jobName}(${career})</td><td>${fmt(salary)}</td><td>${count}</td><td style="text-align:right;">${fmt(subtotal)}</td></tr>`;
        rowIdx++;
    });

    const fee = Math.round(totalLabor * feeRate / 100);
    const calcTotal = totalLabor + fee;

    const noteLines = [];
    noteLines.push('위 내용은 예산(안)으로 실제 근무내용 및 근로자 수에 따라 상이할 수 있음.');
    noteLines.push('각 직무별 근로자 인건비의 ' + feeRate + '%를 채용대행 수수료로 책정함.');
    noteLines.push('채용대행 수수료 청구기간: 최소 ' + minMonth + '개월 (협의가능).');
    noteLines.push('부가세 별도 청구함.');
    const userNotes4 = (document.getElementById('quoteNotes').value || '').split('\n').filter(l => l.trim());
    userNotes4.forEach(n => noteLines.push(n));

    const quoteHTML = `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>채용대행 견적서 - ${client}</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>${getQuoteCSS()}</style></head><body>
<div class="document">
${getQuoteHeader('채용대행 견적서', quoteNum, quoteDate, '채용대행 서비스', '월 ' + fmt(finalPrice || calcTotal) + '원')}
<div class="body">
${getQuoteParties(client, site || '-', contact)}

<div class="section">
    <div class="section-title"><span class="num">1</span>견적 내용</div>
    <table class="qt">
        <thead><tr><th style="text-align:left;">항목</th><th>내용</th></tr></thead>
        <tbody>
            <tr><td style="text-align:left;">운영형태</td><td>채용대행</td></tr>
            <tr><td style="text-align:left;">운영시간</td><td>${opTime}</td></tr>
            <tr><td style="text-align:left;">운영장소</td><td>귀사 지정 장소</td></tr>
            <tr><td style="text-align:left;">인력 근무조건</td><td>${workCond}</td></tr>
            <tr><td style="text-align:left;">업무범위</td><td>${workScope}</td></tr>
        </tbody>
    </table>
    <p style="font-size:11px;color:#888;margin-top:6px;">※ 운영 및 업무관련 범위 설정은 상호 합의 하에 추가되거나 변경될 수 있음.</p>
</div>

<div class="section">
    <div class="section-title"><span class="num">2</span>운영 예산안 <span style="font-size:11px;font-weight:400;color:#888;">(단위: 원)</span></div>
    <table class="qt">
        <thead><tr><th style="text-align:left;">계정과목</th><th style="text-align:left;">항목</th><th>단가</th><th>인원</th><th style="text-align:right;">합계</th></tr></thead>
        <tbody>
            ${peopleRows}
            <tr style="background:#f7fafc;"><td style="text-align:left;" colspan="3"><strong>① 소계</strong></td><td>${totalPeople}</td><td style="text-align:right;font-weight:600;">${fmt(totalLabor)}</td></tr>
            <tr><td style="text-align:left;"><strong>수수료</strong></td><td style="text-align:left;">소개수수료</td><td>${feeRate}%</td><td></td><td style="text-align:right;">${fmt(fee)}</td></tr>
            <tr style="background:#f7fafc;"><td style="text-align:left;" colspan="3"><strong>② 소계</strong></td><td></td><td style="text-align:right;font-weight:600;">${fmt(fee)}</td></tr>
        </tbody>
        <tfoot>
            <tr><td style="text-align:left;" colspan="3"><strong>합계 (①+②) (VAT 별도)</strong></td><td></td><td style="text-align:right;" class="highlight">${fmt(calcTotal)}</td></tr>
            ${(finalPrice && finalPrice !== calcTotal) ? '<tr><td style="text-align:left;" colspan="3"><strong style="color:#e53e3e;">최종 제안가</strong></td><td></td><td style="text-align:right;font-size:16px;font-weight:700;color:#e53e3e;">' + fmt(finalPrice) + '</td></tr>' : ''}
        </tfoot>
    </table>
</div>

${getServiceDescription('recruit')}
${getIndustryPackage()}

<div class="section">
    <div class="section-title"><span class="num">3</span>기타사항</div>
    <div class="note-box">
        ${noteLines.map((l,i) => '<p>'+(i+1)+'. '+l.trim()+'</p>').join('')}
    </div>
</div>
</div>
<div class="footer">워크위드 | 본 견적서는 견적일로부터 30일간 유효합니다.</div>
</div></body></html>`;

    showQuotePreview(quoteHTML);
}

function printQuote() {
    if (!state.quoteHTML) {
        alert('먼저 견적서를 생성해주세요.');
        return;
    }
    const w = window.open('', '_blank');
    w.document.write(state.quoteHTML);
    w.document.close();
    setTimeout(() => w.print(), 500);
}

// ===== 체크리스트 =====
function toggleCheck(li) {
    li.classList.toggle('checked');
    const idx = Array.from(li.parentElement.children).indexOf(li);
    state.checklist[idx] = li.classList.contains('checked');

    const checked = state.checklist.filter(c => c).length;
    const total = state.checklist.length;
    document.getElementById('progressFill').style.width = (checked/total*100) + '%';
    document.getElementById('progressText').textContent = checked + ' / ' + total + ' 완료';

    // 탭에 완료 표시
    document.querySelectorAll('.tab-btn')[5].querySelector('.tab-num').textContent = checked + '/' + total;

    autoSave();
}

// ===== 자동 저장 =====
function autoSave() {
    // 모든 입력값 수집
    const data = {
        clientName: document.getElementById('clientName').value,
        siteName: document.getElementById('siteName').value,
        industry: document.getElementById('industry').value,
        contactName: document.getElementById('contactName').value,
        contactPhone: document.getElementById('contactPhone').value,
        contactEmail: document.getElementById('contactEmail').value,
        reason: document.getElementById('reason').value,
        memo: document.getElementById('memo').value,
        perShift: document.getElementById('perShift').value,
        hourlyWage: document.getElementById('hourlyWage').value,
        nightPay: document.getElementById('nightPay').value,
        etcCost: document.getElementById('etcCost').value,
        simQuote1: document.getElementById('simQuote1').value,
        simQuote2: document.getElementById('simQuote2').value,
        simQuote3: document.getElementById('simQuote3').value,
        itemDogup: document.getElementById('itemDogup').value,
        itemManage: document.getElementById('itemManage').value,
        itemAdmin: document.getElementById('itemAdmin').value,
        quoteNumber: document.getElementById('quoteNumber').value,
        quoteDate: document.getElementById('quoteDate').value,
        workScope: document.getElementById('workScope').value,
        quoteNotes: document.getElementById('quoteNotes').value,
        finalPrice: document.getElementById('finalPrice').value,
        lessonMemo: document.getElementById('lessonMemo').value,
        ratePension: document.getElementById('ratePension').value,
        rateHealth: document.getElementById('rateHealth').value,
        rateEmploy: document.getElementById('rateEmploy').value,
        rateIndust: document.getElementById('rateIndust').value,
        rateRetire: document.getElementById('rateRetire').value,
        rateNight: document.getElementById('rateNight').value,
        nightStart: document.getElementById('nightStart').value,
        nightEnd: document.getElementById('nightEnd').value,
        s1Start: document.getElementById('s1Start').value,
        s1End: document.getElementById('s1End').value,
        s1OT: document.getElementById('s1OT').value,
        s2Start: document.getElementById('s2Start').value,
        s2End: document.getElementById('s2End').value,
        s2OT: document.getElementById('s2OT').value,
        s3Start: document.getElementById('s3Start').value,
        s3End: document.getElementById('s3End').value,
        s3OT: document.getElementById('s3OT').value,
        // CS대행 필드
        csSeniorCount: document.getElementById('csSeniorCount').value,
        csSeniorSalary: document.getElementById('csSeniorSalary').value,
        csJuniorCount: document.getElementById('csJuniorCount').value,
        csJuniorSalary: document.getElementById('csJuniorSalary').value,
        csASP: document.getElementById('csASP').value,
        csMgmtFee: document.getElementById('csMgmtFee').value,
        csSetupFee: document.getElementById('csSetupFee').value,
        csOpTime: document.getElementById('csOpTime').value,
        csWorkCond: document.getElementById('csWorkCond').value,
        csWorkScope: document.getElementById('csWorkScope').value,
        csAgentFinalPrice: document.getElementById('csAgentFinalPrice').value,
        // CS쉐어링 필드
        shareBaseCall: document.getElementById('shareBaseCall').value,
        shareBaseFee: document.getElementById('shareBaseFee').value,
        sharePerCall: document.getElementById('sharePerCall').value,
        shareComm: document.getElementById('shareComm').value,
        shareOpTime: document.getElementById('shareOpTime').value,
        shareSetupFee: document.getElementById('shareSetupFee').value,
        shareCallStandard: document.getElementById('shareCallStandard').value,
        shareWorkScope: document.getElementById('shareWorkScope').value,
        shareServices: document.getElementById('shareServices').value,
        csShareFinalPrice: document.getElementById('csShareFinalPrice').value,
        // 일반도급 필드
        laborMgmtFee: document.getElementById('laborMgmtFee')?.value || '8',
        laborTransport: document.getElementById('laborTransport')?.value || '100000',
        laborLeaderPay: document.getElementById('laborLeaderPay')?.value || '100000',
        laborBizTax: document.getElementById('laborBizTax')?.value || '0.5',
        laborLongCare: document.getElementById('laborLongCare')?.value || '13.14',
        // 채용대행 필드
        recruitOpTime: document.getElementById('recruitOpTime')?.value || '',
        recruitWorkCond: document.getElementById('recruitWorkCond')?.value || '',
        recruitWorkScope: document.getElementById('recruitWorkScope')?.value || '',
        recruitFeeRate: document.getElementById('recruitFeeRate')?.value || '8',
        recruitMinMonth: document.getElementById('recruitMinMonth')?.value || '3',
        recruitFinalPrice: document.getElementById('recruitFinalPrice')?.value || '',
        // 채용대행 직무 행 데이터
        recruitRowsData: (() => {
            const rows = document.getElementById('recruitRows')?.querySelectorAll('tr') || [];
            const arr = [];
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const selects = row.querySelectorAll('select');
                if (inputs.length >= 3) {
                    arr.push({
                        job: inputs[0].value,
                        career: selects.length > 0 ? selects[0].value : '신입',
                        salary: inputs[1].value,
                        count: inputs[2].value
                    });
                }
            });
            return arr;
        })(),
        state: state,
        savedAt: new Date().toISOString()
    };

    localStorage.setItem('ww_quote_current', JSON.stringify(data));

    // 저장 상태 표시
    document.getElementById('saveStatus').textContent = '저장됨 ' + new Date().toLocaleTimeString('ko-KR', {hour:'2-digit',minute:'2-digit'});
}

function loadSaved() {
    const saved = localStorage.getItem('ww_quote_current');
    if (!saved) { showHistory(); return; }
    const data = JSON.parse(saved);

    // 하위 호환: 사무/CS → 사무/행정
    if (data.industry === '사무/CS') data.industry = '사무/행정';

    // 필드 복원
    const fields = ['clientName','siteName','industry','contactName','contactPhone','contactEmail',
        'reason','memo','perShift','hourlyWage','nightPay','etcCost',
        'simQuote1','simQuote2','simQuote3','itemDogup','itemManage','itemAdmin',
        'quoteNumber','quoteDate','workScope','quoteNotes','finalPrice','lessonMemo',
        'ratePension','rateHealth','rateEmploy','rateIndust','rateRetire','rateNight',
        'nightStart','nightEnd',
        's1Start','s1End','s1OT','s2Start','s2End','s2OT','s3Start','s3End','s3OT',
        'csSeniorCount','csSeniorSalary','csJuniorCount','csJuniorSalary',
        'csASP','csMgmtFee','csSetupFee','csOpTime','csWorkCond','csWorkScope','csAgentFinalPrice',
        'shareBaseCall','shareBaseFee','sharePerCall','shareComm','shareOpTime','shareSetupFee',
        'shareCallStandard','shareWorkScope','shareServices','csShareFinalPrice',
        'laborMgmtFee','laborTransport','laborLeaderPay','laborBizTax','laborLongCare',
        'recruitOpTime','recruitWorkCond','recruitWorkScope','recruitFeeRate','recruitMinMonth','recruitFinalPrice'];

    fields.forEach(id => {
        const el = document.getElementById(id);
        if (el && data[id] !== undefined) el.value = data[id];
    });

    // 채용대행 직무 행 복원
    if (data.recruitRowsData && data.recruitRowsData.length > 0) {
        const tbody = document.getElementById('recruitRows');
        if (tbody) {
            tbody.innerHTML = '';
            data.recruitRowsData.forEach(r => addRecruitRow(r.job, r.career, r.salary, r.count));
        }
    }

    // 상태 복원
    if (data.state) {
        state = data.state;
        // 옵션 버튼 복원
        restoreOptions('source', state.source);
        restoreOptions('currentOps', state.currentOps);
        restoreOptions('opDays', state.opDays);
        restoreOptions('manager', state.manager);
        restoreOptions('result', state.result);

        // 견적 유형 복원
        if (state.quoteType) {
            switchQuoteType(state.quoteType, null);
            document.querySelectorAll('.type-card').forEach(c => {
                const types = { outsource: '정액제 도급', labor: '일반 도급', 'cs-agent': 'CS대행', 'cs-share': 'CS쉐어링', recruit: '채용대행' };
                if (c.querySelector('.type-name').textContent === types[state.quoteType]) c.classList.add('selected');
                else c.classList.remove('selected');
            });
        }

        // 3교대 행 표시 복원
        if (state.shiftPreset) {
            const preset = shiftPresets[state.shiftPreset];
            if (preset && preset.show3) document.getElementById('shift3Row').style.display = '';
        }

        // 체크리스트 복원
        if (state.checklist) {
            document.querySelectorAll('.checklist li').forEach((li, i) => {
                if (state.checklist[i]) {
                    li.classList.add('checked');
                }
            });
            const checked = state.checklist.filter(c => c).length;
            document.getElementById('progressFill').style.width = (checked/10*100) + '%';
            document.getElementById('progressText').textContent = checked + ' / 10 완료';
        }
    }

    calcPersonnel();
    calcCost();
    if (state.quoteType === 'cs-agent') calcCSAgent();
    if (state.quoteType === 'cs-share') calcCSShare();
    if (state.quoteType === 'recruit') calcRecruit();

    alert('불러왔습니다. (저장 시간: ' + new Date(data.savedAt).toLocaleString('ko-KR') + ')');
}

function restoreOptions(group, value) {
    if (!value) return;
    document.querySelectorAll('.option-btn').forEach(btn => {
        const parent = btn.parentElement;
        // 같은 그룹의 버튼인지 확인 (간이)
        if (btn.textContent.trim() === value) {
            const siblings = parent.querySelectorAll('.option-btn');
            // 같은 그룹인지 추정
            siblings.forEach(s => {
                if (getGroup(s) === group) s.classList.remove('selected');
            });
            if (getGroup(btn) === group) btn.classList.add('selected');
        }
    });
}

function getGroup(btn) {
    const onclick = btn.getAttribute('onclick') || '';
    const match = onclick.match(/selectOption\(this,'(\w+)'\)/);
    return match ? match[1] : '';
}

function resetAll() {
    if (!confirm('현재 데이터를 모두 초기화하시겠습니까?\n(이전 데이터는 브라우저에 남아있습니다)')) return;

    // 현재 데이터 백업
    const backup = localStorage.getItem('ww_quote_current');
    if (backup) {
        const history = JSON.parse(localStorage.getItem('ww_quote_history') || '[]');
        history.push(JSON.parse(backup));
        if (history.length > 20) history.shift(); // 최대 20개
        localStorage.setItem('ww_quote_history', JSON.stringify(history));
    }

    // 초기화
    document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(el => {
        if (el.id === 'hourlyWage') el.value = '10500';
        else if (el.id === 'perShift') el.value = '4';
        else if (el.id === 'etcCost') el.value = '1000000';
        else if (el.id === 'ratePension') el.value = '4.5';
        else if (el.id === 'rateHealth') el.value = '3.545';
        else if (el.id === 'rateEmploy') el.value = '0.9';
        else if (el.id === 'rateIndust') el.value = '1.5';
        else if (el.id === 'rateRetire') el.value = '8.33';
        else if (el.id === 'rateNight') el.value = '50';
        else if (el.className.includes('scenario-input')) {}
        else el.value = '';
    });

    document.querySelectorAll('.option-btn.selected').forEach(b => b.classList.remove('selected'));
    document.querySelectorAll('.checklist li.checked').forEach(li => li.classList.remove('checked'));

    state = { quoteType:'outsource', source:'', currentOps:'', opDays:'주7일', shifts:'2교대', manager:'1명 배치', result:'', shiftPreset:'service', checklist:[false,false,false,false,false,false,false,false,false,false] };
    switchQuoteType('outsource', document.querySelector('.type-card'));

    // 기본 선택 복원
    document.querySelectorAll('.option-btn').forEach(btn => {
        if (['주7일','1명 배치','서비스업'].includes(btn.textContent.trim())) {
            btn.classList.add('selected');
        }
    });

    // 교대 프리셋 기본값 복원
    applyShiftPreset('service', document.querySelector('.option-btn.selected'));

    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('progressText').textContent = '0 / 10 완료';
    document.getElementById('quotePreview').innerHTML = '';

    switchTab(0);
    autoSave();
}

// ===== 유틸리티 =====
function fmt(n) {
    return Math.round(n).toLocaleString('ko-KR');
}

function fmtMan(n) {
    return Math.round(n / 10000).toLocaleString('ko-KR');
}

function numToKorean(n) {
    const units = ['', '만', '억'];
    const nums = ['영', '일', '이', '삼', '사', '오', '육', '칠', '팔', '구'];
    const subUnits = ['', '십', '백', '천'];

    if (n === 0) return '영';
    let result = '';
    let unitIdx = 0;

    while (n > 0) {
        let part = n % 10000;
        if (part > 0) {
            let partStr = '';
            let subIdx = 0;
            while (part > 0) {
                let digit = part % 10;
                if (digit > 0) {
                    partStr = (digit === 1 && subIdx > 0 ? '' : nums[digit]) + subUnits[subIdx] + partStr;
                }
                part = Math.floor(part / 10);
                subIdx++;
            }
            result = partStr + units[unitIdx] + result;
        }
        n = Math.floor(n / 10000);
        unitIdx++;
    }
    return result;
}

function formatKoreanDate(d) {
    return d.getFullYear() + '년 ' + (d.getMonth()+1) + '월 ' + d.getDate() + '일';
}

// ===== 요율 설정 토글 =====
function toggleRates() {
    document.getElementById('rateSettings').classList.toggle('open');
}

// ===== 이력 저장 =====
function saveToHistory() {
    const client = document.getElementById('clientName').value || '(미입력)';
    const site = document.getElementById('siteName').value || '';
    if (client === '(미입력)' && !site) {
        if (!confirm('업체명이 비어있습니다. 그래도 저장하시겠습니까?')) return;
    }

    // 현재 데이터 수집 (autoSave와 동일)
    autoSave();
    const current = JSON.parse(localStorage.getItem('ww_quote_current') || '{}');

    // 견적 금액 계산
    const d = parseInt(document.getElementById('itemDogup').value) || 0;
    const m = parseInt(document.getElementById('itemManage').value) || 0;
    const a = parseInt(document.getElementById('itemAdmin').value) || 0;
    const quoteAmount = (d + m + a) * 10000;

    // 이력에 추가 메타 정보 붙이기
    current._meta = {
        client: client,
        site: site,
        industry: document.getElementById('industry').value || '',
        quoteAmount: quoteAmount,
        totalCost: state.totalCost || 0,
        personnel: state.personnel || 0,
        result: state.result || 'Pending (진행중)',
        savedAt: new Date().toISOString()
    };

    // 이력 배열에 추가
    const history = JSON.parse(localStorage.getItem('ww_quote_history') || '[]');
    history.push(current);
    if (history.length > 50) history.shift(); // 최대 50건
    localStorage.setItem('ww_quote_history', JSON.stringify(history));

    alert('이력에 저장되었습니다. (' + client + ' ' + site + ')');
}

// ===== 이력 조회 =====
function showHistory() {
    const history = JSON.parse(localStorage.getItem('ww_quote_history') || '[]');
    const container = document.getElementById('historyList');

    if (history.length === 0) {
        container.innerHTML = '<div class="history-empty">저장된 견적 이력이 없습니다.<br>상단 [저장] 버튼을 눌러 이력을 쌓아보세요.</div>';
    } else {
        let html = '<div style="font-size:12px;color:#718096;margin-bottom:12px;">총 ' + history.length + '건</div>';

        // 최신순으로 표시
        for (let i = history.length - 1; i >= 0; i--) {
            const item = history[i];
            const meta = item._meta || {};
            const client = meta.client || item.clientName || '(미입력)';
            const site = meta.site || item.siteName || '';
            const amount = meta.quoteAmount || 0;
            const result = meta.result || '';
            const savedAt = meta.savedAt || item.savedAt || '';
            const dateStr = savedAt ? new Date(savedAt).toLocaleDateString('ko-KR', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}) : '';

            let badgeHTML = '';
            if (result.includes('Win')) badgeHTML = '<span class="history-badge badge-win">Win</span>';
            else if (result.includes('Loss')) badgeHTML = '<span class="history-badge badge-loss">Loss</span>';
            else if (result.includes('Pending')) badgeHTML = '<span class="history-badge badge-pending">진행중</span>';

            html += '<div class="history-item">';
            html += '  <div class="history-info">';
            html += '    <div class="history-client">' + client + ' ' + site + badgeHTML + '</div>';
            html += '    <div class="history-meta">' + dateStr + (meta.industry ? ' | ' + meta.industry : '') + (meta.personnel ? ' | ' + meta.personnel + '명' : '') + '</div>';
            html += '  </div>';
            html += '  <div class="history-amount">' + (amount > 0 ? fmt(amount) + '원' : '-') + '</div>';
            html += '  <div class="history-actions">';
            html += '    <button class="btn-load" onclick="loadFromHistory(' + i + ')">불러오기</button>';
            html += '    <button class="btn-del" onclick="deleteHistory(' + i + ')">삭제</button>';
            html += '  </div>';
            html += '</div>';
        }
        container.innerHTML = html;
    }

    document.getElementById('historyModal').classList.add('active');
}

function closeHistory() {
    document.getElementById('historyModal').classList.remove('active');
}

// ===== 이력 불러오기 =====
function loadFromHistory(idx) {
    const history = JSON.parse(localStorage.getItem('ww_quote_history') || '[]');
    if (idx < 0 || idx >= history.length) return;

    if (!confirm('현재 작업 중인 데이터를 덮어씁니다. 계속하시겠습니까?')) return;

    const data = history[idx];

    // 하위 호환: 사무/CS → 사무/행정
    if (data.industry === '사무/CS') data.industry = '사무/행정';

    // 필드 복원
    const fields = ['clientName','siteName','industry','contactName','contactPhone','contactEmail',
        'reason','memo','perShift','hourlyWage','nightPay','etcCost',
        'simQuote1','simQuote2','simQuote3','itemDogup','itemManage','itemAdmin',
        'quoteNumber','quoteDate','workScope','quoteNotes','finalPrice','lessonMemo',
        'ratePension','rateHealth','rateEmploy','rateIndust','rateRetire','rateNight',
        'nightStart','nightEnd',
        's1Start','s1End','s1OT','s2Start','s2End','s2OT','s3Start','s3End','s3OT',
        'csSeniorCount','csSeniorSalary','csJuniorCount','csJuniorSalary',
        'csASP','csMgmtFee','csSetupFee','csOpTime','csWorkCond','csWorkScope','csAgentFinalPrice',
        'shareBaseCall','shareBaseFee','sharePerCall','shareComm','shareOpTime','shareSetupFee',
        'shareCallStandard','shareWorkScope','shareServices','csShareFinalPrice',
        'laborMgmtFee','laborTransport','laborLeaderPay','laborBizTax','laborLongCare',
        'recruitOpTime','recruitWorkCond','recruitWorkScope','recruitFeeRate','recruitMinMonth','recruitFinalPrice'];

    fields.forEach(id => {
        const el = document.getElementById(id);
        if (el && data[id] !== undefined) el.value = data[id];
    });

    // 채용대행 직무 행 복원
    if (data.recruitRowsData && data.recruitRowsData.length > 0) {
        const tbody = document.getElementById('recruitRows');
        if (tbody) {
            tbody.innerHTML = '';
            data.recruitRowsData.forEach(r => addRecruitRow(r.job, r.career, r.salary, r.count));
        }
    }

    // 상태 복원
    if (data.state) {
        state = data.state;
        restoreOptions('source', state.source);
        restoreOptions('currentOps', state.currentOps);
        restoreOptions('opDays', state.opDays);
        restoreOptions('manager', state.manager);
        restoreOptions('result', state.result);

        // 견적 유형 복원
        if (state.quoteType) {
            switchQuoteType(state.quoteType, null);
            document.querySelectorAll('.type-card').forEach(c => {
                const types = { outsource: '정액제 도급', labor: '일반 도급', 'cs-agent': 'CS대행', 'cs-share': 'CS쉐어링', recruit: '채용대행' };
                if (c.querySelector('.type-name').textContent === types[state.quoteType]) c.classList.add('selected');
                else c.classList.remove('selected');
            });
        }

        // 3교대 행 표시 복원
        if (state.shiftPreset) {
            const preset = shiftPresets[state.shiftPreset];
            if (preset && preset.show3) document.getElementById('shift3Row').style.display = '';
        }

        if (state.checklist) {
            document.querySelectorAll('.checklist li').forEach((li, i) => {
                li.classList.toggle('checked', !!state.checklist[i]);
            });
            const checked = state.checklist.filter(c => c).length;
            document.getElementById('progressFill').style.width = (checked/10*100) + '%';
            document.getElementById('progressText').textContent = checked + ' / 10 완료';
        }
    }

    calcPersonnel();
    calcCost();
    if (state.quoteType === 'cs-agent') calcCSAgent();
    if (state.quoteType === 'cs-share') calcCSShare();
    if (state.quoteType === 'recruit') calcRecruit();
    closeHistory();
    switchTab(0);

    alert('불러왔습니다. (' + (data._meta?.client || data.clientName || '') + ')');
}

// ===== 이력 삭제 =====
function deleteHistory(idx) {
    const history = JSON.parse(localStorage.getItem('ww_quote_history') || '[]');
    if (idx < 0 || idx >= history.length) return;

    const meta = history[idx]._meta || {};
    const name = (meta.client || '(미입력)') + ' ' + (meta.site || '');
    if (!confirm(name.trim() + ' 이력을 삭제하시겠습니까?')) return;

    history.splice(idx, 1);
    localStorage.setItem('ww_quote_history', JSON.stringify(history));
    showHistory(); // 새로고침
}

// ===== 초기화 =====
window.addEventListener('DOMContentLoaded', function() {
    // 견적번호 기본값
    const today = new Date();
    const dateStr = today.toISOString().slice(0,10).replace(/-/g,'');
    document.getElementById('quoteNumber').value = 'WW-' + dateStr + '-01';
    document.getElementById('quoteDate').value = formatKoreanDate(today);

    // 저장된 데이터 자동 복원
    const saved = localStorage.getItem('ww_quote_current');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            // 오늘 날짜와 같은 날 저장된 것만 자동 복원
            const savedDate = new Date(data.savedAt).toDateString();
            if (savedDate === today.toDateString()) {
                loadSaved();
                return;
            }
        } catch(e) {}
    }

    // 초기 계산
    switchQuoteType('outsource', document.querySelector('.type-card'));
    calcPersonnel();
    calcCost();
});
</script>

</body>
</html>
